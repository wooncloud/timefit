### 업체 구성원 목록 조회 API 테스트 - JWT 기반

### 1. OWNER 사용자 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "members-owner@timefit.com",
  "password": "SecureP@ss123!",
  "name": "김사장",
  "phoneNumber": "010-1111-2222"
}

> {%
    client.test("OWNER 회원가입 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.headers.valueOf("Authorization"), "Authorization 헤더가 있어야 함");
    });

    const ownerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("ownerAuthHeader", ownerAuthHeader);
    client.global.set("ownerUserId", response.body.data.userId);

    console.log("OWNER 회원가입 성공 - ID:", response.body.data.userId);
    console.log("OWNER 이름:", response.body.data.name);
%}

### 2. OWNER 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{ownerAuthHeader}}

{
  "businessName": "구성원 테스트 카페",
  "businessType": "카페",
  "businessNumber": "123-45-67890",
  "address": "서울시 강남구 테스트로 123",
  "contactPhone": "02-1234-5678",
  "description": "구성원 목록 조회 테스트용 카페입니다"
}

> {%
    client.test("업체 생성 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.body.data.businessId, "businessId가 있어야 함");
    });

    if (response.body.data) {
        const businessId = response.body.data.businessId;
        client.global.set("businessId", businessId);
        console.log("업체 생성 성공 - ID:", businessId);
        console.log("업체명:", response.body.data.businessName);
    }
%}

### 3. 구성원 목록 조회 - 성공 케이스 (OWNER 혼자만 있는 상태)
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{ownerAuthHeader}}

> {%
    client.test("구성원 목록 조회 성공 (OWNER만)", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(Array.isArray(response.body.data), "응답 데이터가 배열이어야 함");
        client.assert(response.body.data.length === 1, "구성원이 1명이어야 함");
        client.assert(response.body.data[0].role === "OWNER", "유일한 구성원이 OWNER여야 함");
    });

    console.log("=== 초기 구성원 목록 (OWNER만) ===");
    console.log("OWNER 구성원 조회 응답 상태:", response.status);
    console.log("OWNER 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.body.data && Array.isArray(response.body.data)) {
        console.log("구성원 수:", response.body.data.length);

        response.body.data.forEach((member, index) => {
            console.log(`구성원 ${index + 1}:`, {
                name: member.name,
                email: member.email,
                role: member.role,
                isActive: member.isActive,
                joinedAt: member.joinedAt,
                invitedByName: member.invitedByName
            });
        });

        // OWNER 본인이 목록에 있는지 확인
        const ownerMember = response.body.data.find(m => m.role === "OWNER");
        if (ownerMember) {
            console.log("✅ OWNER가 구성원 목록에 포함됨");
            console.log("OWNER 정보:", ownerMember.name, ownerMember.email);
        }
    }
%}

### 4. MANAGER 사용자 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "members-manager@timefit.com",
  "password": "SecureP@ss123!",
  "name": "박매니저",
  "phoneNumber": "010-2222-3333"
}

> {%
    const managerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("managerAuthHeader", managerAuthHeader);
    client.global.set("managerUserId", response.body.data.userId);

    console.log("MANAGER 회원가입 성공 - ID:", response.body.data.userId);
%}

### 5. MEMBER 사용자 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "members-member@timefit.com",
  "password": "SecureP@ss123!",
  "name": "이멤버",
  "phoneNumber": "010-3333-4444"
}

> {%
    const memberAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("memberAuthHeader", memberAuthHeader);
    client.global.set("memberUserId", response.body.data.userId);

    console.log("MEMBER 회원가입 성공 - ID:", response.body.data.userId);
%}

### 6. MANAGER 초대
POST http://localhost:8080/api/business/{{businessId}}/members/invite
Content-Type: application/json
Authorization: {{ownerAuthHeader}}

{
  "email": "members-manager@timefit.com",
  "role": "MANAGER",
  "invitationMessage": "매니저로 초대합니다"
}

> {%
    console.log("MANAGER 초대 성공");
%}

### 7. MEMBER 초대
POST http://localhost:8080/api/business/{{businessId}}/members/invite
Content-Type: application/json
Authorization: {{ownerAuthHeader}}

{
  "email": "members-member@timefit.com",
  "role": "MEMBER",
  "invitationMessage": "멤버로 초대합니다"
}

> {%
    console.log("MEMBER 초대 성공");
%}

### 8. 구성원 목록 조회 - 성공 케이스 (OWNER 권한, 전체 구성원)
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{ownerAuthHeader}}

> {%
    client.test("전체 구성원 목록 조회 성공 (OWNER)", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(Array.isArray(response.body.data), "응답 데이터가 배열이어야 함");
        client.assert(response.body.data.length === 3, "구성원이 3명이어야 함");
    });

    console.log("=== 전체 구성원 목록 (OWNER 조회) ===");
    console.log("전체 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.body.data && Array.isArray(response.body.data)) {
        console.log("총 구성원 수:", response.body.data.length);

        // 권한별로 구성원 정리
        const roleGroups = {
            OWNER: [],
            MANAGER: [],
            MEMBER: []
        };

        response.body.data.forEach((member, index) => {
            console.log(`구성원 ${index + 1}:`, {
                name: member.name,
                email: member.email,
                role: member.role,
                isActive: member.isActive,
                joinedAt: member.joinedAt,
                invitedByName: member.invitedByName
            });

            roleGroups[member.role].push(member);
        });

        console.log("권한별 구성원 수:");
        console.log("- OWNER:", roleGroups.OWNER.length, "명");
        console.log("- MANAGER:", roleGroups.MANAGER.length, "명");
        console.log("- MEMBER:", roleGroups.MEMBER.length, "명");

        // 검증
        if (roleGroups.OWNER.length === 1) {
            console.log("✅ OWNER 1명 확인");
        }
        if (roleGroups.MANAGER.length === 1) {
            console.log("✅ MANAGER 1명 확인");
        }
        if (roleGroups.MEMBER.length === 1) {
            console.log("✅ MEMBER 1명 확인");
        }
    }
%}

### 9. 구성원 목록 조회 - 성공 케이스 (MANAGER 권한)
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{managerAuthHeader}}

> {%
    client.test("구성원 목록 조회 성공 (MANAGER)", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(Array.isArray(response.body.data), "응답 데이터가 배열이어야 함");
        client.assert(response.body.data.length === 3, "구성원이 3명이어야 함");
    });

    console.log("=== 구성원 목록 (MANAGER 권한으로 조회) ===");
    console.log("MANAGER 구성원 조회 응답 상태:", response.status);
    console.log("MANAGER 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.body.data) {
        console.log("MANAGER가 조회한 구성원 수:", response.body.data.length);
        response.body.data.forEach((member, index) => {
            console.log(`${index + 1}. ${member.name} - ${member.role}`);
        });
        console.log("✅ MANAGER도 구성원 목록 조회 가능함 확인");
    }
%}

### 10. 실패 케이스 - MEMBER 권한으로 구성원 목록 조회
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{memberAuthHeader}}

> {%
    client.test("MEMBER 권한 구성원 목록 조회 차단", function() {
        client.assert(response.status === 403, "응답 코드가 403이어야 함");
        client.assert(response.body.error?.code === "INSUFFICIENT_PERMISSION", "에러 코드가 INSUFFICIENT_PERMISSION여야 함");
    });

    console.log("=== MEMBER 권한 구성원 목록 조회 테스트 ===");
    console.log("MEMBER 구성원 조회 응답 상태:", response.status);
    console.log("MEMBER 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 403) {
        console.log("✅ MEMBER 권한 구성원 목록 조회 차단 성공");
        console.log("에러 코드:", response.body.error?.code);
    }
%}

### 11. 실패 케이스 - 토큰 없이 구성원 목록 조회
GET http://localhost:8080/api/business/{{businessId}}/members

> {%
    client.test("토큰 없는 구성원 목록 조회 차단", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("=== 토큰 없는 구성원 목록 조회 테스트 ===");
    console.log("토큰 없는 구성원 조회 응답 상태:", response.status);
    console.log("토큰 없는 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 401) {
        console.log("✅ 토큰 없는 구성원 목록 조회 차단 성공");
    }
%}

### 12. 실패 케이스 - 존재하지 않는 업체의 구성원 목록 조회
GET http://localhost:8080/api/business/00000000-0000-0000-0000-000000000000/members
Authorization: {{ownerAuthHeader}}

> {%
    client.test("존재하지 않는 업체 구성원 목록 조회 차단", function() {
        client.assert(response.status === 404, "응답 코드가 404여야 함");
        client.assert(response.body.error?.code === "BUSINESS_NOT_FOUND", "에러 코드가 BUSINESS_NOT_FOUND여야 함");
    });

    console.log("=== 존재하지 않는 업체 구성원 목록 조회 테스트 ===");
    console.log("존재하지 않는 업체 구성원 조회 응답 상태:", response.status);
    console.log("존재하지 않는 업체 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 404) {
        console.log("✅ 존재하지 않는 업체 구성원 목록 조회 차단 성공");
        console.log("에러 코드:", response.body.error?.code);
    }
%}

### 13. 다른 사용자 회원가입 (권한 없는 접근 테스트용)
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "outsider@timefit.com",
  "password": "SecureP@ss123!",
  "name": "외부인",
  "phoneNumber": "010-9999-8888"
}

> {%
    const outsiderAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("outsiderAuthHeader", outsiderAuthHeader);
    console.log("외부인 회원가입 성공");
%}

### 14. 실패 케이스 - 권한 없는 사용자가 구성원 목록 조회
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{outsiderAuthHeader}}

> {%
    client.test("권한 없는 사용자 구성원 목록 조회 차단", function() {
        client.assert(response.status === 403, "응답 코드가 403이어야 함");
        client.assert(response.body.error?.code === "USER_NOT_BUSINESS_MEMBER", "에러 코드가 USER_NOT_BUSINESS_MEMBER여야 함");
    });

    console.log("=== 권한 없는 사용자 구성원 목록 조회 테스트 ===");
    console.log("권한 없는 사용자 구성원 조회 응답 상태:", response.status);
    console.log("권한 없는 사용자 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 403) {
        console.log("✅ 권한 없는 사용자 구성원 목록 조회 차단 성공");
        console.log("에러 코드:", response.body.error?.code);
    }
%}

### 15. 실패 케이스 - 잘못된 UUID 형식으로 구성원 목록 조회
GET http://localhost:8080/api/business/invalid-uuid-format/members
Authorization: {{ownerAuthHeader}}

> {%
    client.test("잘못된 UUID 형식 구성원 목록 조회 차단", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("=== 잘못된 UUID 형식 구성원 목록 조회 테스트 ===");
    console.log("잘못된 UUID 구성원 조회 응답 상태:", response.status);
    console.log("잘못된 UUID 구성원 조회 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 400) {
        console.log("✅ 잘못된 UUID 형식 구성원 목록 조회 차단 성공");
    }
%}

### 16. 최종 구성원 목록 확인 및 통계
GET http://localhost:8080/api/business/{{businessId}}/members
Authorization: {{ownerAuthHeader}}

> {%
    console.log("=== 최종 구성원 목록 및 통계 ===");
    console.log("최종 구성원 목록:", JSON.stringify(response.body, null, 2));

    if (response.body.data && Array.isArray(response.body.data)) {
        const members = response.body.data;

        console.log("총 구성원 수:", members.length);

        // 권한별 통계
        const stats = {
            totalMembers: members.length,
            ownerCount: members.filter(m => m.role === "OWNER").length,
            managerCount: members.filter(m => m.role === "MANAGER").length,
            memberCount: members.filter(m => m.role === "MEMBER").length,
            activeMembers: members.filter(m => m.isActive !== false).length
        };

        console.log("구성원 통계:", stats);

        // 각 구성원 상세 정보
        console.log("\n=== 구성원 상세 정보 ===");
        members.forEach((member, index) => {
            console.log(`${index + 1}. ${member.name} (${member.email})`);
            console.log(`   - 권한: ${member.role}`);
            console.log(`   - 활성 상태: ${member.isActive}`);
            console.log(`   - 참여일: ${member.joinedAt}`);
            console.log(`   - 초대자: ${member.invitedByName || '업체 생성자'}`);
            console.log("");
        });

        // 검증
        if (stats.ownerCount === 1 && stats.managerCount === 1 && stats.memberCount === 1) {
            console.log("✅ 모든 권한별 구성원이 정상적으로 포함됨");
        }
        if (stats.activeMembers === stats.totalMembers) {
            console.log("✅ 모든 구성원이 활성 상태임");
        }
    }
%}

### 17. JWT 토큰 상태 확인 (디버깅용)
GET http://localhost:8080/api/auth/status-test
Authorization: {{ownerAuthHeader}}

> {%
    console.log("=== JWT 토큰 상태 확인 ===");
    console.log("토큰 상태:", response.status);
    console.log("토큰 응답:", JSON.stringify(response.body, null, 2));
%}