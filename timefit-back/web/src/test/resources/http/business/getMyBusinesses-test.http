### 내 업체 목록 조회 API 테스트 - JWT 기반

### 1. 업체 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "my-business-test@timefit.com",
  "password": "SecureP@ss123!",
  "name": "김사장",
  "phoneNumber": "010-1234-5678"
}

> {%
    client.test("회원가입 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.headers.valueOf("Authorization"), "Authorization 헤더가 있어야 함");
        client.assert(response.body.data.accessToken, "accessToken이 응답에 있어야 함");
    });

    const authHeader = response.headers.valueOf("Authorization");
    const accessToken = response.body.data.accessToken;
    client.global.set("authHeader", authHeader);
    client.global.set("accessToken", accessToken);
    client.global.set("userId", response.body.data.userId);

    console.log("회원가입 성공 - Authorization:", authHeader?.substring(0, 30) + "...");
    console.log("사용자 정보:", response.body.data.name, response.body.data.email);
    console.log("사용자 ID:", response.body.data.userId);
%}

### 2. 로그인 (토큰 획득)
POST http://localhost:8080/api/auth/signin
Content-Type: application/json

{
  "email": "my-business-test@timefit.com",
  "password": "SecureP@ss123!"
}

> {%
    client.test("로그인 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(response.headers.valueOf("Authorization"), "Authorization 헤더가 있어야 함");
        client.assert(response.body.data.accessToken, "accessToken이 응답에 있어야 함");
    });

    const loginAuthHeader = response.headers.valueOf("Authorization");
    const loginAccessToken = response.body.data.accessToken;
    client.global.set("businessToken", loginAuthHeader);
    client.global.set("businessAccessToken", loginAccessToken);

    console.log("로그인 성공 - Authorization:", loginAuthHeader?.substring(0, 30) + "...");
    console.log("Access Token:", loginAccessToken?.substring(0, 30) + "...");
    console.log("사용자 정보:", response.body.data.name, response.body.data.email);
%}

### 3. 토큰 유효성
GET http://localhost:8080/api/auth/status-test
Authorization: {{businessToken}}

> {%
    client.test("토큰 유효성 검증", function() {
        client.assert(response.status === 200, "토큰이 유효해야 함");
    });

    console.log("=== JWT 토큰 유효성 검증 ===");
    console.log("토큰 상태:", response.status);
    console.log("토큰 응답:", JSON.stringify(response.body, null, 2));
%}

### 4. 내 업체 목록 조회 - 업체 없는 상태 (초기 상태)
GET http://localhost:8080/api/business
Authorization: {{businessToken}}

> {%
    client.test("내 업체 목록 조회 - 빈 목록", function() {
        // 업체가 없으면 BUSINESS_NOT_FOUND 에러가 발생할 수 있음
        client.assert(response.status === 404 || response.status === 200, "404 또는 200 응답이어야 함");
    });

    console.log("=== 초기 내 업체 목록 조회 (업체 없음) ===");
    console.log("응답 상태:", response.status);
    console.log("응답 내용:", JSON.stringify(response.body, null, 2));

    if (response.status === 404) {
        console.log("✅ 업체가 없어서 BUSINESS_NOT_FOUND 에러 정상");
        console.log("에러 코드:", response.body.error?.code);
    } else if (response.status === 200 && Array.isArray(response.body.data)) {
        console.log("업체 수:", response.body.data.length);
    }
%}

### 5. 첫 번째 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessToken}}

{
  "businessName": "내 카페",
  "businessType": "카페",
  "businessNumber": "123-45-67890",
  "address": "서울시 강남구 테스트로 123",
  "contactPhone": "02-1234-5678",
  "description": "내가 운영하는 첫 번째 카페입니다"
}

> {%
    client.test("첫 번째 업체 생성 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.body.data.businessId, "businessId가 있어야 함");
    });

    if (response.body.data) {
        const businessId1 = response.body.data.businessId;
        client.global.set("businessId1", businessId1);
        console.log("첫 번째 업체 생성 성공 - ID:", businessId1);
        console.log("업체명:", response.body.data.businessName);
        console.log("내 권한:", response.body.data.myRole);
    }
%}

### 6. 두 번째 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessToken}}

{
  "businessName": "내 미용실",
  "businessType": "미용실",
  "businessNumber": "987-65-43210",
  "address": "서울시 강남구 뷰티로 456",
  "contactPhone": "02-9876-5432",
  "description": "프리미엄 헤어 디자인 미용실입니다"
}

> {%
    client.test("두 번째 업체 생성 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.body.data.businessId, "businessId가 있어야 함");
    });

    if (response.body.data) {
        const businessId2 = response.body.data.businessId;
        client.global.set("businessId2", businessId2);
        console.log("두 번째 업체 생성 성공 - ID:", businessId2);
        console.log("업체명:", response.body.data.businessName);
        console.log("내 권한:", response.body.data.myRole);
    }
%}

### 7. 내 업체 목록 조회 - 업체 2개 있는 상태
GET http://localhost:8080/api/business
Authorization: {{businessToken}}

> {%
    client.test("내 업체 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(Array.isArray(response.body.data), "data가 배열이어야 함");
        client.assert(response.body.data.length === 2, "업체가 2개여야 함");
    });

    console.log("=== 내 업체 목록 조회 (2개 업체) ===");
    console.log("내 업체 목록:", JSON.stringify(response.body, null, 2));

    if (response.body.data && Array.isArray(response.body.data)) {
        console.log("총 업체 수:", response.body.data.length);

        response.body.data.forEach((business, index) => {
            console.log(`업체 ${index + 1}:`, {
                businessId: business.businessId,
                businessName: business.businessName,
                businessType: business.businessType,
                myRole: business.myRole,
                totalMembers: business.totalMembers,
                isActive: business.isActive,
                joinedAt: business.joinedAt
            });

            // 검증
            if (business.myRole === "OWNER") {
                console.log(`✅ 업체 ${index + 1}: OWNER 권한 확인`);
            }
            if (business.totalMembers === 1) {
                console.log(`✅ 업체 ${index + 1}: 구성원 1명(본인만) 확인`);
            }
            if (business.isActive === true) {
                console.log(`✅ 업체 ${index + 1}: 활성 상태 확인`);
            }
        });

        // 업체명 확인
        const cafeExists = response.body.data.some(b => b.businessName === "내 카페");
        const salonExists = response.body.data.some(b => b.businessName === "내 미용실");

        if (cafeExists) {
            console.log("✅ 카페 업체 목록에서 확인됨");
        }
        if (salonExists) {
            console.log("✅ 미용실 업체 목록에서 확인됨");
        }
    }
%}

### 8. 다른 사용자 회원가입 (구성원 초대 테스트용)
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "member-user@timefit.com",
  "password": "SecureP@ss123!",
  "name": "박직원",
  "phoneNumber": "010-9999-8888"
}

> {%
    const memberAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("memberAuthHeader", memberAuthHeader);
    client.global.set("memberUserId", response.body.data.userId);

    console.log("구성원용 사용자 회원가입 성공 - ID:", response.body.data.userId);
%}

### 9. 첫 번째 업체에 구성원 초대
POST http://localhost:8080/api/business/{{businessId1}}/members/invite
Content-Type: application/json
Authorization: {{businessToken}}

{
  "email": "member-user@timefit.com",
  "role": "MEMBER",
  "invitationMessage": "저희 카페에 직원으로 초대합니다"
}

> {%
    console.log("구성원 초대 성공");
%}

### 10. 구성원으로 추가된 사용자의 업체 목록 조회
GET http://localhost:8080/api/business
Authorization: {{memberAuthHeader}}

> {%
    client.test("구성원 업체 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(Array.isArray(response.body.data), "data가 배열이어야 함");
        client.assert(response.body.data.length >= 1, "최소 1개 업체가 있어야 함");
    });

    console.log("=== 구성원 사용자의 업체 목록 ===");
    console.log("구성원 업체 목록:", JSON.stringify(response.body, null, 2));

    if (response.body.data && Array.isArray(response.body.data)) {
        console.log("구성원이 속한 업체 수:", response.body.data.length);

        response.body.data.forEach((business, index) => {
            console.log(`업체 ${index + 1}:`, {
                businessName: business.businessName,
                myRole: business.myRole,
                totalMembers: business.totalMembers,
                joinedAt: business.joinedAt
            });

            if (business.myRole === "MEMBER") {
                console.log(`✅ 업체 ${index + 1}: MEMBER 권한 확인`);
            }
        });

        // 카페에 MEMBER로 속해있는지 확인
        const cafeAsMember = response.body.data.find(b =>
            b.businessName === "내 카페" && b.myRole === "MEMBER"
        );

        if (cafeAsMember) {
            console.log("✅ 카페에 MEMBER로 정상 초대됨");
            console.log("카페 총 구성원 수:", cafeAsMember.totalMembers);
        }
    }
%}

### 11. 실패 케이스 - 토큰 없이 내 업체 목록 조회
GET http://localhost:8080/api/business

> {%
    client.test("토큰 없는 업체 목록 조회 차단", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("=== 토큰 없는 업체 목록 조회 테스트 ===");
    console.log("토큰 없는 요청 응답 상태:", response.status);
    console.log("토큰 없는 요청 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 401) {
        console.log("✅ 토큰 없는 업체 목록 조회 차단 성공");
    }
%}

### 12. 실패 케이스 - 잘못된 토큰으로 내 업체 목록 조회
GET http://localhost:8080/api/business
Authorization: Bearer invalid-token-12345

> {%
    client.test("잘못된 토큰 업체 목록 조회 차단", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("=== 잘못된 토큰 업체 목록 조회 테스트 ===");
    console.log("잘못된 토큰 요청 응답 상태:", response.status);
    console.log("잘못된 토큰 요청 응답:", JSON.stringify(response.body, null, 2));

    if (response.status === 401) {
        console.log("✅ 잘못된 토큰 업체 목록 조회 차단 성공");
    }
%}

### 13. 응답 전체 디버깅 - 최종 상태 확인
GET http://localhost:8080/api/business
Authorization: {{businessToken}}

> {%
    console.log("=== 응답 전체 분석 ===");
    console.log("Status Code:", response.status);
    console.log("Response Body:", JSON.stringify(response.body, null, 2));
    console.log("Success:", response.body.success);
    console.log("Message:", response.body.message || "없음");
    console.log("Error Code:", response.body.error?.code || "없음");

    if (response.body.data && Array.isArray(response.body.data)) {
        console.log("\n=== 상세 분석 ===");
        console.log("총 업체 수:", response.body.data.length);

        // 권한별 통계
        const roleStats = response.body.data.reduce((acc, business) => {
            acc[business.myRole] = (acc[business.myRole] || 0) + 1;
            return acc;
        }, {});

        console.log("권한별 업체 수:", roleStats);

        // 업종별 통계
        const typeStats = response.body.data.reduce((acc, business) => {
            acc[business.businessType] = (acc[business.businessType] || 0) + 1;
            return acc;
        }, {});

        console.log("업종별 업체 수:", typeStats);

        // 활성 상태 통계
        const activeCount = response.body.data.filter(b => b.isActive === true).length;
        const inactiveCount = response.body.data.filter(b => b.isActive === false).length;

        console.log("활성 업체:", activeCount, "개");
        console.log("비활성 업체:", inactiveCount, "개");

        // 구성원 수 통계
        const totalMembersSum = response.body.data.reduce((sum, b) => sum + (b.totalMembers || 0), 0);
        console.log("전체 구성원 수 합계:", totalMembersSum, "명");

        console.log("\n=== 업체별 상세 정보 ===");
        response.body.data.forEach((business, index) => {
            console.log(`업체 ${index + 1}:`);
            console.log(`  - ID: ${business.businessId}`);
            console.log(`  - 이름: ${business.businessName}`);
            console.log(`  - 업종: ${business.businessType}`);
            console.log(`  - 내 권한: ${business.myRole}`);
            console.log(`  - 구성원 수: ${business.totalMembers}명`);
            console.log(`  - 활성 상태: ${business.isActive}`);
            console.log(`  - 참여일: ${business.joinedAt}`);
            console.log(`  - 로고: ${business.logoUrl || '없음'}`);
            console.log("");
        });
    }
%}