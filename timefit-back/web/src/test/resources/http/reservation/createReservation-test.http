### 예약 신청 API 테스트 (핵심 기능) - 고객 권한

### 1. 고객 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "create-customer@timefit.com",
  "password": "SecureP@ss123!",
  "name": "예약신청테스트고객",
  "phoneNumber": "010-1111-2222"
}

> {%
    client.test("고객 회원가입 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.headers.valueOf("Authorization"), "Authorization 헤더가 있어야 함");
    });

    const customerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("customerAuthHeader", customerAuthHeader);
    console.log("고객 회원가입 성공");
%}

### 2. 업체 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "create-business@timefit.com",
  "password": "SecureP@ss123!",
  "name": "업체관리자",
  "phoneNumber": "010-2222-3333"
}

> {%
    const businessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("businessAuthHeader", businessAuthHeader);
    console.log("업체 회원가입 성공");
%}

### 3. 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessName": "예약신청 테스트 피트니스",
  "businessType": "피트니스",
  "businessNumber": "555-55-55555",
  "address": "서울시 송파구 신청로 555",
  "contactPhone": "02-5555-5555",
  "description": "예약 신청 테스트용 피트니스센터"
}

> {%
    if (response.body.data) {
        const businessId = response.body.data.businessId;
        console.log("업체 생성 성공:", businessId);
        client.global.set("businessId", businessId);
    }
%}

### 4. 영업시간 설정
PUT http://localhost:8080/api/schedule/operating-hours?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessHours": [
    {
      "dayOfWeek": 1,
      "openTime": "06:00",
      "closeTime": "23:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 2,
      "openTime": "06:00",
      "closeTime": "23:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 3,
      "openTime": "06:00",
      "closeTime": "23:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 4,
      "openTime": "06:00",
      "closeTime": "23:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 5,
      "openTime": "06:00",
      "closeTime": "23:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 6,
      "openTime": "08:00",
      "closeTime": "22:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 0,
      "openTime": null,
      "closeTime": null,
      "isClosed": true
    }
  ]
}

> {%
    console.log("영업시간 설정 완료");
%}

### 5. 예약 슬롯 생성 (2026년 날짜)
POST http://localhost:8080/api/schedule/available-slots?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "slots": [
    {
      "slotDate": "2026-09-15",
      "startTime": "09:00",
      "endTime": "10:00",
      "capacity": 5
    },
    {
      "slotDate": "2026-09-15",
      "startTime": "19:00",
      "endTime": "20:00",
      "capacity": 3
    }
  ]
}

> {%
    console.log("=== 슬롯 생성 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 201 && response.body.data && response.body.data.createdSlots && response.body.data.createdSlots.length >= 2) {
        const slot1 = response.body.data.createdSlots[0];
        const slot2 = response.body.data.createdSlots[1];

        console.log("슬롯 1 생성:", slot1.slotId, "(2026-09-15 09:00-10:00, 용량:5)");
        console.log("슬롯 2 생성:", slot2.slotId, "(2026-09-15 19:00-20:00, 용량:3)");

        client.global.set("slot1Id", slot1.slotId);
        client.global.set("slot2Id", slot2.slotId);

        console.log("✅ 예약 슬롯 생성 완료");
    } else {
        console.log("❌ 슬롯 생성 실패");
    }
%}

### 6. ✅ 성공 케이스 - 첫 번째 예약 신청
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-09-15",
  "reservationTime": "09:00",
  "durationMinutes": 60,
  "totalPrice": 30000,
  "customerName": "예약신청테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "첫 번째 예약입니다. 운동 초보자예요."
}

> {%
    console.log("=== 첫 번째 예약 신청 ===");
    console.log("응답 상태:", response.status);
    console.log("응답 본문:", JSON.stringify(response.body, null, 2));

    client.test("첫 번째 예약 신청 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.body.success === true, "success가 true여야 함");
        client.assert(response.body.data, "응답 데이터가 있어야 함");
        client.assert(response.body.data.reservationId, "reservationId가 있어야 함");
    });

    if (response.status === 201 && response.body.data) {
        const reservationId = response.body.data.reservationId;
        const reservationNumber = response.body.data.reservationNumber;

        console.log("✅ 첫 번째 예약 신청 성공");
        console.log("예약 ID:", reservationId);
        console.log("예약 번호:", reservationNumber);
        console.log("예약 상태:", response.body.data.status);
        console.log("예약 날짜:", response.body.data.reservationDate);
        console.log("예약 시간:", response.body.data.reservationTime);
        console.log("총 금액:", response.body.data.totalPrice);

        client.global.set("reservation1Id", reservationId);

        // 가격 확인
        if (response.body.data.totalPrice === 30000) {
            console.log("✅ 가격이 정확히 설정됨: 30,000원");
        } else {
            console.log("⚠️ 가격 확인 필요:", response.body.data.totalPrice);
        }
    } else {
        console.log("❌ 첫 번째 예약 신청 실패");
        if (response.body.message) {
            console.log("실패 이유:", response.body.message);
        }
    }
%}

### 7. ✅ 성공 케이스 - 두 번째 예약 신청 (다른 시간대)
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot2Id}}",
  "reservationDate": "2026-09-15",
  "reservationTime": "19:00",
  "durationMinutes": 60,
  "totalPrice": 35000,
  "customerName": "예약신청테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "저녁 시간 예약입니다."
}

> {%
    console.log("=== 두 번째 예약 신청 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 201 && response.body.data) {
        const reservationId = response.body.data.reservationId;

        console.log("✅ 두 번째 예약 신청 성공");
        console.log("예약 ID:", reservationId);
        console.log("예약 번호:", response.body.data.reservationNumber);
        console.log("총 금액:", response.body.data.totalPrice);

        client.global.set("reservation2Id", reservationId);
    } else {
        console.log("❌ 두 번째 예약 신청 실패");
    }
%}

### 8. ❌ 실패 케이스 - 토큰 없이 예약 신청
POST http://localhost:8080/api/reservation
Content-Type: application/json

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-09-15",
  "reservationTime": "09:00",
  "durationMinutes": 60,
  "totalPrice": 30000,
  "customerName": "무권한고객",
  "customerPhone": "010-9999-9999",
  "notes": "토큰 없이 예약 시도"
}

> {%
    client.test("토큰 없는 예약 신청 실패", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("❌ 토큰 없는 예약 신청 차단됨 (401)");
%}

### 9. ❌ 실패 케이스 - 존재하지 않는 슬롯으로 예약
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "00000000-0000-0000-0000-000000000000",
  "reservationDate": "2026-09-15",
  "reservationTime": "09:00",
  "durationMinutes": 60,
  "totalPrice": 30000,
  "customerName": "예약신청테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "존재하지 않는 슬롯으로 예약 시도"
}

> {%
    client.test("존재하지 않는 슬롯 예약 실패", function() {
        client.assert(response.status === 400 || response.status === 404, "응답 코드가 400 또는 404여야 함");
    });

    console.log("❌ 존재하지 않는 슬롯 예약 차단됨");
%}

### 10. ❌ 실패 케이스 - 필수 필드 누락 (고객명 없음)
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-09-15",
  "reservationTime": "09:00",
  "durationMinutes": 60,
  "totalPrice": 30000,
  "customerPhone": "010-1111-2222",
  "notes": "고객명 필드 누락"
}

> {%
    client.test("필수 필드 누락 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 필수 필드(고객명) 누락 차단됨 (400)");
%}

### 11. ✅ 최종 검증 - 생성된 예약 목록 조회
GET http://localhost:8080/api/reservation
Authorization: {{customerAuthHeader}}

> {%
    console.log("=== 생성된 예약 목록 조회 ===");
    console.log("응답 상태:", response.status);

    client.test("예약 목록 조회 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
    });

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("총 예약 수:", reservations.length);

        reservations.forEach((reservation, index) => {
            console.log(`${index + 1}. 예약번호: ${reservation.reservationNumber}`);
            console.log(`   날짜: ${reservation.reservationDate} ${reservation.reservationTime}`);
            console.log(`   상태: ${reservation.status}`);
            console.log(`   가격: ${reservation.totalPrice}원`);
        });

        const successfulReservations = reservations.filter(r => r.status === "PENDING");
        if (successfulReservations.length === 2) {
            console.log("✅ 2개의 예약이 성공적으로 생성됨");
        }
    }

    console.log("\n=== 테스트 완료 시나리오 ===");
    console.log("✅ 정상 예약 신청 (2건)");
    console.log("❌ 권한 없는 예약 차단 (토큰 없음)");
    console.log("❌ 잘못된 요청 차단 (존재하지 않는 슬롯, 필수 필드 누락)");
    console.log("✅ 생성된 예약 목록 조회");
%}