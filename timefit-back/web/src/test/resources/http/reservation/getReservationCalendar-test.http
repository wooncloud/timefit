### 예약 캘린더 조회 API 테스트 (핵심 기능) - 업체 권한

### 1. 고객 회원가입 (예약 생성용)
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "calendar-customer@timefit.com",
  "password": "SecureP@ss123!",
  "name": "캘린더테스트고객",
  "phoneNumber": "010-1111-2222"
}

> {%
    const customerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("customerAuthHeader", customerAuthHeader);
    console.log("고객 회원가입 성공");
%}

### 2. 업체 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "calendar-business@timefit.com",
  "password": "SecureP@ss123!",
  "name": "캘린더테스트사장",
  "phoneNumber": "010-2222-3333"
}

> {%
    const businessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("businessAuthHeader", businessAuthHeader);
    console.log("업체 회원가입 성공");
%}

### 3. 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessName": "캘린더 테스트 스튜디오",
  "businessType": "스튜디오",
  "businessNumber": "777-77-77777",
  "address": "서울시 마포구 캘린더로 777",
  "contactPhone": "02-7777-7777",
  "description": "예약 캘린더 테스트용 스튜디오"
}

> {%
    if (response.body.data) {
        const businessId = response.body.data.businessId;
        console.log("업체 생성 성공:", businessId);
        client.global.set("businessId", businessId);
    }
%}

### 4. 영업시간 설정
PUT http://localhost:8080/api/schedule/operating-hours?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessHours": [
    {"dayOfWeek": 1, "openTime": "09:00", "closeTime": "18:00", "isClosed": false},
    {"dayOfWeek": 2, "openTime": "09:00", "closeTime": "18:00", "isClosed": false},
    {"dayOfWeek": 3, "openTime": "09:00", "closeTime": "18:00", "isClosed": false},
    {"dayOfWeek": 4, "openTime": "09:00", "closeTime": "18:00", "isClosed": false},
    {"dayOfWeek": 5, "openTime": "09:00", "closeTime": "18:00", "isClosed": false},
    {"dayOfWeek": 6, "openTime": "10:00", "closeTime": "17:00", "isClosed": false},
    {"dayOfWeek": 0, "openTime": null, "closeTime": null, "isClosed": true}
  ]
}

> {%
    console.log("영업시간 설정 완료");
%}

### 5. 예약 슬롯 생성 (2026년 11월)
POST http://localhost:8080/api/schedule/available-slots?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "slots": [
    {"slotDate": "2026-11-02", "startTime": "10:00", "endTime": "11:00", "capacity": 3},
    {"slotDate": "2026-11-02", "startTime": "14:00", "endTime": "15:00", "capacity": 2},
    {"slotDate": "2026-11-03", "startTime": "11:00", "endTime": "12:00", "capacity": 4},
    {"slotDate": "2026-11-05", "startTime": "15:00", "endTime": "16:00", "capacity": 1},
    {"slotDate": "2026-11-10", "startTime": "09:30", "endTime": "10:30", "capacity": 5}
  ]
}

> {%
    if (response.status === 201 && response.body.data && response.body.data.createdSlots && response.body.data.createdSlots.length >= 5) {
        const slot1 = response.body.data.createdSlots[0];
        const slot2 = response.body.data.createdSlots[1];
        const slot3 = response.body.data.createdSlots[2];
        const slot4 = response.body.data.createdSlots[3];
        const slot5 = response.body.data.createdSlots[4];

        client.global.set("slot1Id", slot1.slotId);
        client.global.set("slot2Id", slot2.slotId);
        client.global.set("slot3Id", slot3.slotId);
        client.global.set("slot4Id", slot4.slotId);
        client.global.set("slot5Id", slot5.slotId);

        console.log("✅ 5개 슬롯 생성 완료");
    }
%}

### 6. 테스트용 예약 생성 - 11월 2일 오전
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-11-02",
  "reservationTime": "10:00",
  "durationMinutes": 60,
  "totalPrice": 40000,
  "customerName": "캘린더테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "11월 2일 오전 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("✅ 11월 2일 오전 예약 생성:", response.body.data.reservationNumber);
        client.global.set("reservation1Id", response.body.data.reservationId);
    }
%}

### 7. 테스트용 예약 생성 - 11월 2일 오후
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot2Id}}",
  "reservationDate": "2026-11-02",
  "reservationTime": "14:00",
  "durationMinutes": 60,
  "totalPrice": 45000,
  "customerName": "캘린더테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "11월 2일 오후 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("✅ 11월 2일 오후 예약 생성:", response.body.data.reservationNumber);
        client.global.set("reservation2Id", response.body.data.reservationId);
    }
%}

### 8. 테스트용 예약 생성 - 11월 3일
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot3Id}}",
  "reservationDate": "2026-11-03",
  "reservationTime": "11:00",
  "durationMinutes": 60,
  "totalPrice": 35000,
  "customerName": "캘린더테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "11월 3일 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("✅ 11월 3일 예약 생성:", response.body.data.reservationNumber);
        client.global.set("reservation3Id", response.body.data.reservationId);
    }
%}

### 9. ✅ 성공 케이스 - 예약 캘린더 조회 (일주일 기간)
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-11-01&endDate=2026-11-07
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 예약 캘린더 조회 (2026-11-01 ~ 2026-11-07) ===");
    console.log("응답 상태:", response.status);
    console.log("응답 본문:", JSON.stringify(response.body, null, 2));

    client.test("예약 캘린더 조회 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(response.body.success === true, "success가 true여야 함");
        client.assert(response.body.data, "응답 데이터가 있어야 함");
    });

    if (response.status === 200 && response.body.data) {
        console.log("✅ 예약 캘린더 조회 성공");

        const data = response.body.data;

        // 업체 정보 확인
        if (data.businessInfo) {
            console.log("업체명:", data.businessInfo.businessName);
            console.log("주소:", data.businessInfo.address);
        }

        // 캘린더 정보 확인
        if (data.calendarInfo) {
            console.log("조회 기간:", data.calendarInfo.startDate, "~", data.calendarInfo.endDate);
            console.log("캘린더 일수:", data.calendarInfo.calendarDays ? data.calendarInfo.calendarDays.length : 0);

            if (data.calendarInfo.calendarDays) {
                console.log("\n=== 날짜별 예약 현황 ===");
                data.calendarInfo.calendarDays.forEach((day, index) => {
                    const reservationCount = day.reservations ? day.reservations.length : 0;
                    console.log(`${day.date}: ${reservationCount}건 예약`);

                    if (reservationCount > 0) {
                        day.reservations.forEach((reservation, idx) => {
                            console.log(`  ${idx + 1}. ${reservation.reservationTime} - ${reservation.customerName} (${reservation.status})`);
                        });
                    }
                });
            }
        }
    } else {
        console.log("❌ 예약 캘린더 조회 실패");
    }
%}

### 10. ✅ 성공 케이스 - 월간 캘린더 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-11-01&endDate=2026-11-30
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 월간 캘린더 조회 (2026년 11월) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.calendarInfo) {
        const calendarDays = response.body.data.calendarInfo.calendarDays;
        console.log("✅ 월간 캘린더 조회 성공");
        console.log("전체 일수:", calendarDays ? calendarDays.length : 0);

        if (calendarDays) {
            const totalReservations = calendarDays.reduce((sum, day) =>
                sum + (day.reservations ? day.reservations.length : 0), 0);
            console.log("총 예약 수:", totalReservations);

            const daysWithReservations = calendarDays.filter(day =>
                day.reservations && day.reservations.length > 0);
            console.log("예약이 있는 날:", daysWithReservations.length + "일");
        }
    }
%}

### 11. ✅ 성공 케이스 - 특정 날짜 캘린더 조회 (단일 날짜)
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-11-02&endDate=2026-11-02
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 특정 날짜 캘린더 조회 (2026-11-02) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.calendarInfo) {
        const calendarDays = response.body.data.calendarInfo.calendarDays;
        console.log("✅ 특정 날짜 캘린더 조회 성공");

        if (calendarDays && calendarDays.length > 0) {
            const day = calendarDays[0];
            console.log("날짜:", day.date);
            console.log("예약 수:", day.reservations ? day.reservations.length : 0);

            if (day.reservations && day.reservations.length > 0) {
                console.log("예약 목록:");
                day.reservations.forEach((reservation, idx) => {
                    console.log(`  ${idx + 1}. ${reservation.reservationTime} - ${reservation.customerName}`);
                    console.log(`     상태: ${reservation.status}, 가격: ${reservation.totalPrice}원`);
                });

                // 11월 2일에는 2개의 예약이 있어야 함
                if (day.reservations.length === 2) {
                    console.log("✅ 예상한 예약 수와 일치함");
                }
            }
        }
    }
%}

### 12. ❌ 실패 케이스 - 토큰 없이 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-11-01&endDate=2026-11-07

> {%
    client.test("토큰 없는 캘린더 조회 실패", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("❌ 토큰 없는 캘린더 조회 차단됨 (401)");
%}

### 13. ❌ 실패 케이스 - 다른 업체가 조회 시도
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "another-calendar-business@timefit.com",
  "password": "SecureP@ss123!",
  "name": "다른업체사장",
  "phoneNumber": "010-4444-5555"
}

> {%
    const anotherBusinessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("anotherBusinessAuthHeader", anotherBusinessAuthHeader);
    console.log("다른 업체 사장 생성 완료");
%}

### 14. ❌ 실패 케이스 - 권한 없는 업체의 캘린더 조회 시도
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-11-01&endDate=2026-11-07
Authorization: {{anotherBusinessAuthHeader}}

> {%
    client.test("권한 없는 업체의 캘린더 조회 실패", function() {
        client.assert(response.status === 403, "응답 코드가 403이어야 함");
    });

    console.log("❌ 권한 없는 업체의 캘린더 조회 차단됨 (403)");
%}

### 15. ❌ 실패 케이스 - 존재하지 않는 업체 조회
GET http://localhost:8080/api/business/00000000-0000-0000-0000-000000000000/reservation/calendar?startDate=2026-11-01&endDate=2026-11-07
Authorization: {{businessAuthHeader}}

> {%
    client.test("존재하지 않는 업체 캘린더 조회 실패", function() {
        client.assert(response.status === 404, "응답 코드가 404여야 함");
    });

    console.log("❌ 존재하지 않는 업체 캘린더 조회 차단됨 (404)");
%}

### 16. ❌ 실패 케이스 - 잘못된 날짜 형식
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=invalid-date&endDate=2026-11-07
Authorization: {{businessAuthHeader}}

> {%
    client.test("잘못된 날짜 형식 조회 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 잘못된 날짜 형식 조회 차단됨 (400)");
%}

### 17. ❌ 실패 케이스 - 너무 긴 기간 조회 (1년 초과)
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-01-01&endDate=2027-12-31
Authorization: {{businessAuthHeader}}

> {%
    client.test("너무 긴 기간 조회 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 너무 긴 기간 조회 차단됨 (400) - 최대 1년");
%}

### 18. ✅ 성공 케이스 - 예약 없는 기간 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/calendar?startDate=2026-12-01&endDate=2026-12-07
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 예약 없는 기간 조회 (2026-12-01 ~ 2026-12-07) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.calendarInfo) {
        const calendarDays = response.body.data.calendarInfo.calendarDays;
        console.log("✅ 예약 없는 기간 조회 성공");
        console.log("전체 일수:", calendarDays ? calendarDays.length : 0);

        if (calendarDays) {
            const totalReservations = calendarDays.reduce((sum, day) =>
                sum + (day.reservations ? day.reservations.length : 0), 0);

            if (totalReservations === 0) {
                console.log("✅ 예약 없는 기간 정상 처리됨");
            } else {
                console.log("⚠️ 예약이 없어야 하는데 예약이 발견됨:", totalReservations + "건");
            }
        }
    }

    console.log("\n=== 테스트 완료 시나리오 ===");
    console.log("✅ 일주일 기간 캘린더 조회");
    console.log("✅ 월간 캘린더 조회");
    console.log("✅ 특정 날짜 캘린더 조회");
    console.log("✅ 예약 없는 기간 조회");
    console.log("❌ 권한 없는 접근 차단 (토큰 없음, 다른 업체, 존재하지 않는 업체)");
    console.log("❌ 잘못된 요청 차단 (날짜 형식 오류, 기간 초과)");
%}