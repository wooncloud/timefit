### 예약 수정 API 테스트 (핵심 기능) - 고객 권한

### 1. 고객 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "update-customer@timefit.com",
  "password": "SecureP@ss123!",
  "name": "예약수정고객",
  "phoneNumber": "010-1111-2222"
}

> {%
    client.test("고객 회원가입 성공", function() {
        client.assert(response.status === 201, "응답 코드가 201이어야 함");
        client.assert(response.headers.valueOf("Authorization"), "Authorization 헤더가 있어야 함");
    });

    const customerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("customerAuthHeader", customerAuthHeader);
    console.log("고객 회원가입 성공");
%}

### 2. 업체 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "update-business@timefit.com",
  "password": "SecureP@ss123!",
  "name": "수정테스트업체사장",
  "phoneNumber": "010-2222-3333"
}

> {%
    const businessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("businessAuthHeader", businessAuthHeader);
    console.log("업체 회원가입 성공");
%}

### 3. 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessName": "예약수정 테스트 클리닉",
  "businessType": "클리닉",
  "businessNumber": "888-88-88888",
  "address": "서울시 강남구 수정로 888",
  "contactPhone": "02-8888-8888",
  "description": "예약 수정 테스트용 클리닉"
}

> {%
    if (response.body.data) {
        const businessId = response.body.data.businessId;
        console.log("업체 생성 성공:", businessId);
        client.global.set("businessId", businessId);
    }
%}

### 4. 영업시간 설정
PUT http://localhost:8080/api/schedule/operating-hours?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessHours": [
    {"dayOfWeek": 1, "openTime": "08:00", "closeTime": "19:00", "isClosed": false},
    {"dayOfWeek": 2, "openTime": "08:00", "closeTime": "19:00", "isClosed": false},
    {"dayOfWeek": 3, "openTime": "08:00", "closeTime": "19:00", "isClosed": false},
    {"dayOfWeek": 4, "openTime": "08:00", "closeTime": "19:00", "isClosed": false},
    {"dayOfWeek": 5, "openTime": "08:00", "closeTime": "19:00", "isClosed": false},
    {"dayOfWeek": 6, "openTime": "09:00", "closeTime": "16:00", "isClosed": false},
    {"dayOfWeek": 0, "openTime": null, "closeTime": null, "isClosed": true}
  ]
}

> {%
    console.log("영업시간 설정 완료");
%}

### 5. 예약 슬롯 생성 (2026년 12월)
POST http://localhost:8080/api/schedule/available-slots?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "slots": [
    {"slotDate": "2026-12-15", "startTime": "09:00", "endTime": "10:00", "capacity": 2},
    {"slotDate": "2026-12-15", "startTime": "14:00", "endTime": "15:00", "capacity": 3},
    {"slotDate": "2026-12-16", "startTime": "11:00", "endTime": "12:00", "capacity": 1}
  ]
}

> {%
    if (response.status === 201 && response.body.data && response.body.data.createdSlots && response.body.data.createdSlots.length >= 3) {
        const slot1 = response.body.data.createdSlots[0];
        const slot2 = response.body.data.createdSlots[1];
        const slot3 = response.body.data.createdSlots[2];

        client.global.set("slot1Id", slot1.slotId);
        client.global.set("slot2Id", slot2.slotId);
        client.global.set("slot3Id", slot3.slotId);

        console.log("✅ 3개 슬롯 생성 완료");
    }
%}

### 6. 수정할 예약 생성
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-12-15",
  "reservationTime": "09:00",
  "durationMinutes": 60,
  "totalPrice": 50000,
  "customerName": "예약수정고객",
  "customerPhone": "010-1111-2222",
  "notes": "초기 예약입니다"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("✅ 수정할 예약 생성:", response.body.data.reservationNumber);
        client.global.set("reservationId", response.body.data.reservationId);
    }
%}

### 7. ✅ 성공 케이스 - 메모만 수정
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "notes": "메모를 수정했습니다. 조금 늦을 수 있어요.",
  "reason": "메모 변경"
}

> {%
    console.log("=== 메모 수정 ===");
    console.log("응답 상태:", response.status);
    console.log("응답 본문:", JSON.stringify(response.body, null, 2));

    client.test("메모 수정 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(response.body.success === true, "success가 true여야 함");
        client.assert(response.body.data, "응답 데이터가 있어야 함");
    });

    if (response.status === 200 && response.body.data) {
        console.log("✅ 메모 수정 성공");
        console.log("수정된 메모:", response.body.data.notes);
    } else {
        console.log("❌ 메모 수정 실패");
    }
%}

### 8. ✅ 성공 케이스 - 연락처 수정
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "customerPhone": "010-9999-8888",
  "notes": "연락처를 변경했습니다.",
  "reason": "연락처 변경"
}

> {%
    console.log("=== 연락처 수정 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data) {
        console.log("✅ 연락처 수정 성공");
        console.log("수정된 연락처:", response.body.data.customerPhone);
    }
%}

### 9. ✅ 성공 케이스 - 다른 슬롯으로 날짜/시간 변경
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "availableSlotId": "{{slot2Id}}",
  "reservationDate": "2026-12-15",
  "reservationTime": "14:00",
  "durationMinutes": 60,
  "notes": "다른 시간으로 변경했습니다.",
  "reason": "시간 변경"
}

> {%
    console.log("=== 슬롯 변경 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data) {
        console.log("✅ 슬롯 변경 성공");
        console.log("변경된 날짜:", response.body.data.reservationDate);
        console.log("변경된 시간:", response.body.data.reservationTime);
    } else {
        console.log("❌ 슬롯 변경 실패");
    }
%}

### 10. ✅ 성공 케이스 - 가격 변경
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "totalPrice": 75000,
  "notes": "가격을 조정했습니다.",
  "reason": "가격 변경"
}

> {%
    console.log("=== 가격 변경 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data) {
        console.log("✅ 가격 변경 성공");
        console.log("변경된 가격:", response.body.data.totalPrice);
    }
%}

### 11. ✅ 수정 후 상태 확인 - 예약 상세 조회
GET http://localhost:8080/api/reservation/{{reservationId}}
Authorization: {{customerAuthHeader}}

> {%
    console.log("=== 수정 후 상태 확인 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data) {
        const reservation = response.body.data;
        console.log("✅ 최종 예약 상태:");
        console.log("예약 번호:", reservation.reservationNumber);
        console.log("현재 날짜:", reservation.reservationDate);
        console.log("현재 시간:", reservation.reservationTime);
        console.log("현재 가격:", reservation.totalPrice);
        console.log("현재 연락처:", reservation.customerPhone);
        console.log("현재 메모:", reservation.notes);
    }
%}

### 12. ❌ 실패 케이스 - 토큰 없이 수정
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json

{
  "notes": "토큰 없이 수정 시도",
  "reason": "테스트"
}

> {%
    client.test("토큰 없는 예약 수정 실패", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("❌ 토큰 없는 예약 수정 차단됨 (401)");
%}

### 13. ❌ 실패 케이스 - 존재하지 않는 예약 수정
PATCH http://localhost:8080/api/reservation/00000000-0000-0000-0000-000000000000
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "notes": "존재하지 않는 예약 수정 시도",
  "reason": "테스트"
}

> {%
    client.test("존재하지 않는 예약 수정 실패", function() {
        client.assert(response.status === 404, "응답 코드가 404여야 함");
    });

    console.log("❌ 존재하지 않는 예약 수정 차단됨 (404)");
%}

### 14. ❌ 실패 케이스 - 다른 고객의 예약 수정 시도
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "another-update-customer@timefit.com",
  "password": "SecureP@ss123!",
  "name": "다른고객",
  "phoneNumber": "010-3333-4444"
}

> {%
    const anotherCustomerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("anotherCustomerAuthHeader", anotherCustomerAuthHeader);
    console.log("다른 고객 생성 완료");
%}

### 15. ❌ 실패 케이스 - 권한 없는 예약 수정
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{anotherCustomerAuthHeader}}

{
  "notes": "다른 고객이 수정을 시도합니다.",
  "reason": "권한 테스트"
}

> {%
    client.test("권한 없는 예약 수정 실패", function() {
        client.assert(response.status === 403 || response.status === 404, "응답 코드가 403 또는 404여야 함");
    });

    console.log("❌ 다른 고객의 예약 수정 차단됨 (403/404)");
%}

### 16. ❌ 실패 케이스 - 잘못된 날짜 형식
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "reservationDate": "invalid-date",
  "notes": "잘못된 날짜 형식 테스트",
  "reason": "테스트"
}

> {%
    client.test("잘못된 날짜 형식 수정 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 잘못된 날짜 형식 수정 차단됨 (400)");
%}

### 17. ❌ 실패 케이스 - 음수 가격
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "totalPrice": -50000,
  "notes": "음수 가격 테스트",
  "reason": "테스트"
}

> {%
    client.test("음수 가격 수정 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 음수 가격 수정 차단됨 (400)");
%}

### 18. ❌ 실패 케이스 - 과거 날짜로 변경
PATCH http://localhost:8080/api/reservation/{{reservationId}}
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "reservationDate": "2024-01-01",
  "reservationTime": "14:00",
  "notes": "과거 날짜로 변경 시도",
  "reason": "테스트"
}

> {%
    client.test("과거 날짜 수정 실패", function() {
        client.assert(response.status === 400, "응답 코드가 400이어야 함");
    });

    console.log("❌ 과거 날짜 변경 차단됨 (400)");
%}

### 19. ✅ 최종 검증 - 예약 목록에서 수정 내용 확인
GET http://localhost:8080/api/reservation
Authorization: {{customerAuthHeader}}

> {%
    console.log("=== 예약 목록에서 수정 내용 확인 ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("✅ 예약 목록 조회 성공");

        const modifiedReservation = reservations.find(r => r.reservationId === client.global.get("reservationId"));
        if (modifiedReservation) {
            console.log("수정된 예약 확인:");
            console.log("- 예약 번호:", modifiedReservation.reservationNumber);
            console.log("- 날짜:", modifiedReservation.reservationDate);
            console.log("- 시간:", modifiedReservation.reservationTime);
            console.log("- 가격:", modifiedReservation.totalPrice);
            console.log("- 연락처:", modifiedReservation.customerPhone);
            console.log("- 메모:", modifiedReservation.notes);

            // 최종 수정 값들이 반영되었는지 확인
            if (modifiedReservation.reservationTime === "14:00" &&
                modifiedReservation.totalPrice === 75000 &&
                modifiedReservation.customerPhone === "010-9999-8888") {
                console.log("✅ 모든 수정 사항이 올바르게 반영됨");
            }
        } else {
            console.log("⚠️ 수정된 예약을 찾을 수 없음");
        }
    }

    console.log("\n=== 테스트 완료 시나리오 ===");
    console.log("✅ 메모 수정");
    console.log("✅ 연락처 수정");
    console.log("✅ 날짜/시간 변경 (다른 슬롯)");
    console.log("✅ 가격 변경");
    console.log("✅ 수정 후 상태 확인");
    console.log("❌ 권한 없는 접근 차단 (토큰 없음, 다른 고객, 존재하지 않는 예약)");
    console.log("❌ 잘못된 요청 차단 (날짜 형식, 음수 가격, 과거 날짜)");
%}