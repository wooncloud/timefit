### 업체 예약 조회 API 테스트 (핵심 기능) - 업체 권한

### 1. 고객 회원가입 (예약 생성용)
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "business-query-customer@timefit.com",
  "password": "SecureP@ss123!",
  "name": "업체조회테스트고객",
  "phoneNumber": "010-1111-2222"
}

> {%
    const customerAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("customerAuthHeader", customerAuthHeader);
    console.log("고객 회원가입 성공");
%}

### 2. 업체 회원가입
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "business-query-owner@timefit.com",
  "password": "SecureP@ss123!",
  "name": "업체사장",
  "phoneNumber": "010-2222-3333"
}

> {%
    const businessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("businessAuthHeader", businessAuthHeader);
    console.log("업체 회원가입 성공");
%}

### 3. 업체 생성
POST http://localhost:8080/api/business
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessName": "예약조회 테스트 요가원",
  "businessType": "요가원",
  "businessNumber": "333-33-33333",
  "address": "서울시 마포구 조회로 333",
  "contactPhone": "02-3333-3333",
  "description": "업체 예약 조회 테스트용 요가원"
}

> {%
    if (response.body.data) {
        const businessId = response.body.data.businessId;
        console.log("업체 생성 성공:", businessId);
        client.global.set("businessId", businessId);
    }
%}

### 4. 영업시간 설정
PUT http://localhost:8080/api/schedule/operating-hours?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "businessHours": [
    {
      "dayOfWeek": 1,
      "openTime": "07:00",
      "closeTime": "21:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 2,
      "openTime": "07:00",
      "closeTime": "21:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 3,
      "openTime": "07:00",
      "closeTime": "21:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 4,
      "openTime": "07:00",
      "closeTime": "21:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 5,
      "openTime": "07:00",
      "closeTime": "21:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 6,
      "openTime": "09:00",
      "closeTime": "18:00",
      "isClosed": false
    },
    {
      "dayOfWeek": 0,
      "openTime": null,
      "closeTime": null,
      "isClosed": true
    }
  ]
}

> {%
    console.log("영업시간 설정 완료");
%}

### 5. 예약 슬롯 생성 (2026년 날짜)
POST http://localhost:8080/api/schedule/available-slots?businessId={{businessId}}
Content-Type: application/json
Authorization: {{businessAuthHeader}}

{
  "slots": [
    {
      "slotDate": "2026-10-15",
      "startTime": "08:00",
      "endTime": "09:00",
      "capacity": 10
    },
    {
      "slotDate": "2026-10-15",
      "startTime": "18:00",
      "endTime": "19:00",
      "capacity": 8
    },
    {
      "slotDate": "2026-10-16",
      "startTime": "10:00",
      "endTime": "11:00",
      "capacity": 12
    }
  ]
}

> {%
    if (response.status === 201 && response.body.data && response.body.data.createdSlots && response.body.data.createdSlots.length >= 3) {
        const slot1 = response.body.data.createdSlots[0];
        const slot2 = response.body.data.createdSlots[1];
        const slot3 = response.body.data.createdSlots[2];

        client.global.set("slot1Id", slot1.slotId);
        client.global.set("slot2Id", slot2.slotId);
        client.global.set("slot3Id", slot3.slotId);

        console.log("✅ 3개 슬롯 생성 완료");
    } else {
        console.log("❌ 슬롯 생성 실패");
    }
%}

### 6. 테스트용 예약 3개 생성 - 첫 번째 예약 (PENDING)
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot1Id}}",
  "reservationDate": "2026-10-15",
  "reservationTime": "08:00",
  "durationMinutes": 60,
  "totalPrice": 25000,
  "customerName": "업체조회테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "아침 요가 클래스 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("첫 번째 예약 생성 완료:", response.body.data.reservationNumber);
        client.global.set("reservation1Id", response.body.data.reservationId);
    }
%}

### 7. 테스트용 예약 3개 생성 - 두 번째 예약 (PENDING)
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot2Id}}",
  "reservationDate": "2026-10-15",
  "reservationTime": "18:00",
  "durationMinutes": 60,
  "totalPrice": 30000,
  "customerName": "업체조회테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "저녁 요가 클래스 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("두 번째 예약 생성 완료:", response.body.data.reservationNumber);
        client.global.set("reservation2Id", response.body.data.reservationId);
    }
%}

### 8. 테스트용 예약 3개 생성 - 세 번째 예약 (PENDING)
POST http://localhost:8080/api/reservation
Content-Type: application/json
Authorization: {{customerAuthHeader}}

{
  "businessId": "{{businessId}}",
  "availableSlotId": "{{slot3Id}}",
  "reservationDate": "2026-10-16",
  "reservationTime": "10:00",
  "durationMinutes": 60,
  "totalPrice": 28000,
  "customerName": "업체조회테스트고객",
  "customerPhone": "010-1111-2222",
  "notes": "오전 요가 클래스 예약"
}

> {%
    if (response.status === 201 && response.body.data) {
        console.log("세 번째 예약 생성 완료:", response.body.data.reservationNumber);
        client.global.set("reservation3Id", response.body.data.reservationId);
    }
%}

### 9. ✅ 성공 케이스 - 업체의 모든 예약 조회 (올바른 엔드포인트)
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 업체의 모든 예약 조회 ===");
    console.log("응답 상태:", response.status);
    console.log("응답 본문:", JSON.stringify(response.body, null, 2));

    client.test("업체 예약 조회 성공", function() {
        client.assert(response.status === 200, "응답 코드가 200이어야 함");
        client.assert(response.body.success === true, "success가 true여야 함");
        client.assert(response.body.data, "응답 데이터가 있어야 함");
    });

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("✅ 업체 예약 조회 성공");
        console.log("총 예약 수:", reservations.length);

        reservations.forEach((reservation, index) => {
            console.log(`${index + 1}. 예약번호: ${reservation.reservationNumber}`);
            console.log(`   고객명: ${reservation.customerInfo.customerName}`);
            console.log(`   날짜: ${reservation.reservationDetails.reservationDate} ${reservation.reservationDetails.reservationTime}`);
            console.log(`   상태: ${reservation.status}`);
            console.log(`   가격: ${reservation.reservationDetails.totalPrice}원`);
            console.log(`   연락처: ${reservation.customerInfo.customerPhone}`);
        });

        if (reservations.length === 3) {
            console.log("✅ 3개의 예약이 모두 조회됨");
        }

        // 정렬 확인 (최신순)
        if (reservations.length > 1) {
            const isNewestFirst = new Date(reservations[0].createdAt) >= new Date(reservations[1].createdAt);
            console.log("예약 정렬:", isNewestFirst ? "최신순" : "오래된순");
        }
    } else {
        console.log("❌ 업체 예약 조회 실패");
    }
%}

### 10. ✅ 성공 케이스 - 날짜별 필터링 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests?date=2026-10-15
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 날짜별 예약 조회 (2026-10-15) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("✅ 날짜별 예약 조회 성공");
        console.log("10월 15일 예약 수:", reservations.length);

        const allSameDate = reservations.every(r => r.reservationDetails.reservationDate === "2026-10-15");
        if (allSameDate) {
            console.log("✅ 날짜 필터링이 올바르게 작동함");
        } else {
            console.log("⚠️ 날짜 필터링 확인 필요");
        }

        reservations.forEach((reservation, index) => {
            console.log(`${index + 1}. ${reservation.reservationDetails.reservationTime} - ${reservation.customerInfo.customerName}`);
        });
    }
%}

### 11. ✅ 성공 케이스 - 상태별 필터링 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests?status=PENDING
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 상태별 예약 조회 (PENDING) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("✅ 상태별 예약 조회 성공");
        console.log("PENDING 상태 예약 수:", reservations.length);

        const allPending = reservations.every(r => r.status === "PENDING");
        if (allPending) {
            console.log("✅ 상태 필터링이 올바르게 작동함");
        } else {
            console.log("⚠️ 상태 필터링 확인 필요");
        }
    }
%}

### 12. ❌ 실패 케이스 - 토큰 없이 조회
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests

> {%
    client.test("토큰 없는 업체 예약 조회 실패", function() {
        client.assert(response.status === 401, "응답 코드가 401이어야 함");
    });

    console.log("❌ 토큰 없는 업체 예약 조회 차단됨 (401)");
%}

### 13. ❌ 실패 케이스 - 다른 업체가 조회 시도
POST http://localhost:8080/api/auth/signup
Content-Type: application/json

{
  "email": "another-business-owner@timefit.com",
  "password": "SecureP@ss123!",
  "name": "다른업체사장",
  "phoneNumber": "010-4444-5555"
}

> {%
    const anotherBusinessAuthHeader = response.headers.valueOf("Authorization");
    client.global.set("anotherBusinessAuthHeader", anotherBusinessAuthHeader);
    console.log("다른 업체 사장 생성 완료");
%}

### 14. ❌ 실패 케이스 - 권한 없는 업체의 예약 조회 시도
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests
Authorization: {{anotherBusinessAuthHeader}}

> {%
    client.test("권한 없는 업체의 예약 조회 실패", function() {
        client.assert(response.status === 403, "응답 코드가 403이어야 함");
    });

    console.log("❌ 권한 없는 업체의 예약 조회 차단됨 (403)");
%}

### 15. ❌ 실패 케이스 - 존재하지 않는 업체 조회
GET http://localhost:8080/api/business/00000000-0000-0000-0000-000000000000/reservation/requests
Authorization: {{businessAuthHeader}}

> {%
    client.test("존재하지 않는 업체 조회 실패", function() {
        client.assert(response.status === 404, "응답 코드가 404여야 함");
    });

    console.log("❌ 존재하지 않는 업체 조회 차단됨 (404)");
%}

### 16. ✅ 최종 검증 - 페이징 테스트
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests?page=1&size=2
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 페이징 테스트 (page=1, size=2) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data) {
        console.log("✅ 페이징 조회 성공");

        if (response.body.data.reservations) {
            console.log("조회된 예약 수:", response.body.data.reservations.length);
        }

        if (response.body.data.pagination) {
            console.log("페이징 정보:");
            console.log("- 현재 페이지:", response.body.data.pagination.page);
            console.log("- 페이지 크기:", response.body.data.pagination.size);
            console.log("- 전체 개수:", response.body.data.pagination.totalElements);
            console.log("- 다음 페이지 여부:", response.body.data.pagination.hasNext);
        }
    }

    console.log("\n=== 테스트 완료 시나리오 ===");
    console.log("✅ 업체의 모든 예약 조회");
    console.log("✅ 날짜별 필터링 조회 (2026-10-15)");
    console.log("✅ 상태별 필터링 조회 (PENDING)");
    console.log("✅ 페이징 조회");
    console.log("❌ 권한 없는 접근 차단 (토큰 없음, 다른 업체, 존재하지 않는 업체)");
%}

### 17. ✅ 날짜 범위 필터링 테스트
GET http://localhost:8080/api/business/{{businessId}}/reservation/requests?startDate=2026-10-15&endDate=2026-10-16
Authorization: {{businessAuthHeader}}

> {%
    console.log("=== 날짜 범위 예약 조회 (2026-10-15 ~ 2026-10-16) ===");
    console.log("응답 상태:", response.status);

    if (response.status === 200 && response.body.data && response.body.data.reservations) {
        const reservations = response.body.data.reservations;
        console.log("✅ 날짜 범위 예약 조회 성공");
        console.log("범위 내 예약 수:", reservations.length);

        const inDateRange = reservations.every(r => {
            const reservationDate = r.reservationDetails.reservationDate;
            return reservationDate >= "2026-10-15" && reservationDate <= "2026-10-16";
        });

        if (inDateRange) {
            console.log("✅ 날짜 범위 필터링이 올바르게 작동함");
        } else {
            console.log("⚠️ 날짜 범위 필터링 확인 필요");
        }
    }
%}