# EXPLAIN 테스트 — 파일 구조 설계

## 1. 설계 원칙

| 원칙 | 내용 |
|------|------|
| 1파일 = 1기능 | `예약_등록.sql` 하나에 EXPLAIN 하나 |
| 독립 실행 가능 | 파일 하나를 열어서 실행하면 결과까지 보일 수 있도록 |
| 핵심 쿼리 우선 시각화 | 파일을 열었을 때 "어떤 쿼리를 측정하는지"가 제일 먼저 눈에 보이기 |

---

## 2. 딜레마 해결: 구조 내부의 영역 분리

각 파일 안을 두 영역으로 나눕니다.

```
┌─────────────────────────────────────┐
│  📋 헤더                            │  ← "이 파일은 무엇인지"
│     API, 핵심 쿼리, 사전조건         │
├─────────────────────────────────────┤
│  🔧 픽스처 영역                     │  ← "실행하기 위한 세팅"  (보조)
│     루트 조건 이후의 추가 데이터 만  │
├─────────────────────────────────────┤
│  🔍 EXPLAIN 영역                    │  ← "측정 대상"          (주)
│     핵심 쿼리 하나                   │
└─────────────────────────────────────┘
```

**픽스처 영역의 범위:**  
루트 조건(`_setup.sql`에서 생성된 User, Business)은 파일 안에 넣지 않음.  
그 이후의 체인만 각 파일에 내장.

### 픽스처 크기 결정 규칙

**원칙 1: 체인 부모는 항상 최소 1건**

의존 관계의 상위 엔티티는 항상 1건으로 충분합니다.
측정 대상 테이블이 아닌 이상, 체인 부모의 크기는 EXPLAIN 결과에 영향을 주지 않습니다.

**원칙 2: 측정 대상 테이블 자체는 조건에 따라 결정**

```
WHERE 조건이 PK인가?
  → YES: 최소 1건 (테이블 크기와 무관하게 Index Scan on pkey)
  → NO:  대량 데이터 필요 (100~500건, 테이블이 커야 Bitmap/Index Scan 선택)
```

| WHERE 조건 예시 | 테이블 크기 | 이유 |
|-----------------|------------|------|
| `WHERE id = ?` (PK) | 1건 | PK 조회는 항상 Index Scan. 크기 무관 |
| `WHERE business_id = ?` (FK) | 100~500건 | 테이블이 작으면 Seq Scan만 나옴 |
| `WHERE customer_id = ?` (FK) | 100~500건 | 위와 동일 |
| `WHERE status = 'PENDING'` (일반) | 100~500건 | 위와 동일 |

예시:

| 파일 | 픽스처 크기 | 이유 |
|------|------------|------|
| `02_카테고리_목록_조회.sql` | business_category 100건 | WHERE business_id (비-PK) |
| `03_카테고리_상세_조회.sql` | business_category 1건 | WHERE id (PK) |
| `04_카테고리_수정.sql` | business_category 1건 | WHERE id (PK) |
| `02_내_예약_목록.sql` | reservation 500건 | WHERE customer_id (비-PK) |
| `03_예약_상세_조회.sql` | reservation 1건 | WHERE id (PK) |

**체인 부모 vs 측정 대상의 구분:**

```
reservation/02_내_예약_목록.sql 파일의 경우

  측정 대상: reservation 테이블        → 500건 필요 (WHERE customer_id)
  체인 부모: business_category, menu   → 각 1건으로 충분
            booking_slot             → 각 1건으로 충분
```

---

## 3. 파일 구조

```
explain/
│
├── _setup.sql                          ← 루트 조건 (User, Business) 한 번만 실행
├── _cleanup.sql                        ← 리셋용
│
├── operating_hours/                    ← 사전조건: _setup.sql만
│   ├── 01_영업시간_조회.sql
│   ├── 02_영업시간_설정.sql
│   ├── 03_요일별_휴무_토글.sql
│   └── 04_영업시간_리셋.sql
│
├── business_category/                  ← 사전조건: _setup.sql만
│   ├── 01_카테고리_생성.sql
│   ├── 02_카테고리_목록_조회.sql
│   ├── 03_카테고리_상세_조회.sql
│   ├── 04_카테고리_수정.sql
│   └── 05_카테고리_삭제.sql
│
├── menu/                               ← 사전조건: _setup.sql + BusinessCategory
│   ├── 01_메뉴_생성.sql
│   ├── 02_메뉴_목록_조회.sql
│   ├── 03_메뉴_상세_조회.sql
│   ├── 04_메뉴_수정.sql
│   ├── 05_메뉴_활성_토글.sql
│   └── 06_메뉴_삭제.sql
│
├── booking_slot/                       ← 사전조건: _setup.sql + Category + Menu
│   ├── 01_슬롯_생성.sql
│   ├── 02_날짜별_조회.sql
│   ├── 03_기간별_조회.sql
│   ├── 04_메뉴별_조회.sql
│   ├── 05_향후_조회.sql
│   ├── 06_슬롯_삭제.sql
│   ├── 07_슬롯_비활성화.sql
│   ├── 08_슬롯_재활성화.sql
│   └── 09_과거_일괄_삭제.sql
│
├── reservation/                        ← 사전조건: _setup.sql + ... + BookingSlot
│   ├── 01_예약_등록.sql
│   ├── 02_내_예약_목록.sql
│   ├── 03_예약_상세_조회.sql
│   ├── 04_예약_수정.sql
│   ├── 05_예약_취소.sql
│   ├── 06_업체_예약_목록.sql
│   ├── 07_업체_예약_상세.sql
│   ├── 08_예약_승인.sql
│   ├── 09_예약_거절.sql
│   ├── 10_예약_완료.sql
│   └── 11_노쇼_처리.sql
│
├── review/                             ← 사전조건: _setup.sql + ... + COMPLETED Reservation
│   ├── 01_리뷰_작성.sql
│   ├── 02_내_리뷰_목록.sql
│   ├── 03_리뷰_수정.sql
│   ├── 04_리뷰_삭제.sql
│   ├── 05_업체_리뷰_목록.sql
│   └── 06_업체_리뷰_통계.sql
│
└── wishlist/                           ← 사전조건: _setup.sql + Category + Menu
    ├── 01_찜_목록_조회.sql
    ├── 02_찜_추가.sql
    ├── 03_찜_삭제.sql
    └── 04_찜_여부_확인.sql
```

총 **43개 파일**.

---

## 4. 파일 템플릿

실제 파일 내용의 구조:

```sql
-- ============================================================
-- [기능명]
-- ============================================================
-- API:        [HTTP 메서드] [경로]
-- 핵심 쿼리:  [무엇을 측정하는지 한 줄로]
-- 사전조건:   _setup.sql + [추가로 필요한 것]
-- ============================================================

BEGIN;

-- ============================================================
-- 🔧 픽스처
-- ============================================================
-- _setup.sql (User, Business)은 이미 완료됨
-- 여기에는 그 이후의 체인만 최소 1건씩 생성

INSERT INTO business_category (...) VALUES (...);
INSERT INTO menu (...) VALUES (...);
-- ...

-- ============================================================
-- 🔍 EXPLAIN: [측정 대상 기능명]
-- ============================================================

EXPLAIN (ANALYZE, BUFFERS)
[핵심 쿼리];

-- ============================================================
-- 💡 확인 포인트
-- ============================================================
-- ✅ [이 쿼리에서 확인할 것 1]
-- ✅ [이 쿼리에서 확인할 것 2]

ROLLBACK;
```

---

## 5. 실행 방법

```
1단계: _setup.sql 실행 (최초 1회)
2단계: 원하는 파일을 개별 실행 (순서 무관)

예시:
  "예약 등록이 느리다"
  → reservation/01_예약_등록.sql 열기
  → 실행
  → EXPLAIN 결과로 원인 파악
```

---

## 6. 유지보수 관련 고려사항

| 상황 | 대응 |
|------|------|
| 픽스처가 여러 파일에 중복 | 의도적 중복. 독립 실행성이 더 중요. |
| 체인이 깊은 파일(예약, 리뷰)의 픽스처가 길어진다 | 최소 1건만. 대량 테스트는 별도 단계로 미룸. |
| 엔티티 컬럼이 변경된다 | 해당 체인 이후의 파일들을 갱신. 파일명이 기능명이므로 "어떤 파일이 영향받는지" 추적 가능. |
