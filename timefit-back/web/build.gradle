dependencies {
    implementation project(':user')
    implementation project(':jpa-common')
    implementation project(':domain')

    // Core Spring Boot
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    // Database
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
    runtimeOnly 'org.postgresql:postgresql'

    implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'

    // Security
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'com.auth0:java-jwt:4.0.0'

    // Monitoring & Management
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'io.micrometer:micrometer-registry-prometheus'

    // Utilities
    implementation 'org.springframework.boot:spring-boot-starter-aop'
    implementation 'me.paulschwarz:spring-dotenv:4.0.0'

    // Documentation
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.6.0'

    // Email
    implementation 'org.springframework.boot:spring-boot-starter-mail'

    // Optional (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
    // implementation 'org.springframework.boot:spring-boot-starter-websocket'
    // implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    // Testing
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'com.h2database:h2'
}

// ì‹¤í–‰ ê°€ëŠ¥í•œ JAR ìƒì„± (web ëª¨ë“ˆë§Œ)
jar {
    enabled = false
}

bootJar {
    enabled = true
    archiveClassifier = ''
}

// ========================================
// Scouter Agent ì„¤ì • (ê°œë°œ í™˜ê²½)
// ========================================

bootRun {
    // .env íŒŒì¼ ì½ì–´ì„œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    def envFile = file('../.env')
    if (envFile.exists()) {
        envFile.readLines().each { line ->
            if (line && !line.startsWith('#')) {
                def parts = line.split('=', 2)
                if (parts.length == 2) {
                    environment parts[0].trim(), parts[1].trim()
                }
            }
        }
    }

    // ê³µí†µ JVM ì„¤ì •ê°’
    def commonJvmArgs = [
        // ì´ˆê¸° Heap 1GB
        '-Xms1g',
        // ìµœëŒ€ Heap 2GB (AWS m3.medium ê¸°ì¤€)
        '-Xmx2g',
        // G1 GC ì‚¬ìš©
        '-XX:+UseG1GC',
        // GC ìµœëŒ€ 200ms
        '-XX:MaxGCPauseMillis=200'
    ]

    // Scouter Agent ì„¤ì • (íŒŒì¼ì´ ìˆì„ ë•Œë§Œ í™œì„±í™”)
    def agentDir = file('../../timefit-test/scouter/agent.java')
    def agentJar = new File(agentDir, 'scouter.agent.jar')
    def agentConf = new File(agentDir, 'conf/scouter.conf')

    if (agentJar.exists()) {
        // Spring Boot active profile ì½ê¸°
        def activeProfile = System.getProperty('spring.profiles.active')
                ?: System.getenv('SPRING_PROFILES_ACTIVE')
                ?: 'dev'

        // Profileì— ë”°ë¥¸ obj_name ì„¤ì •
        def objName = "timefit-${activeProfile}"

        jvmArgs = [
                "-javaagent:${agentJar.absolutePath}",
                "-Dscouter.config=${agentConf.absolutePath}",
                "-Dobj_name=${objName}",
                *commonJvmArgs
        ]
        println "ğŸš€ Scouter Agent enabled: ${agentJar.absolutePath}"
    } else {
        jvmArgs = commonJvmArgs
        println "âš ï¸ Scouter Agent not found, skipping..."
    }
}