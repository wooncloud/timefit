# Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ë„ì… ê°€ì´ë“œ

> **ëª©ì **: Timefit í”„ë¡œì íŠ¸ì— Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ë„ì…í•˜ì—¬ ì„±ëŠ¥ ë³‘ëª© í•´ì†Œ  
> **ëŒ€ìƒ ë…ì**: Nginxë¥¼ ì²˜ìŒ ì‚¬ìš©í•˜ëŠ” ë°±ì—”ë“œ ê°œë°œì

---

## ğŸ“‹ ëª©ì°¨

1. [ë°°ê²½ ë° ë¬¸ì œ ìƒí™©](#1-ë°°ê²½-ë°-ë¬¸ì œ-ìƒí™©)
2. [Nginx ë„ì… ì´ìœ ](#2-nginx-ë„ì…-ì´ìœ )
3. [ì•„í‚¤í…ì²˜ ë³€ê²½](#3-ì•„í‚¤í…ì²˜-ë³€ê²½)
4. [ì£¼ìš” ê°œë… ì´í•´](#4-ì£¼ìš”-ê°œë…-ì´í•´)
5. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#5-í”„ë¡œì íŠ¸-êµ¬ì¡°)
6. [ì„¤ì • íŒŒì¼ ìƒì„¸](#6-ì„¤ì •-íŒŒì¼-ìƒì„¸)
7. [ì„¤ì¹˜ ë° ì‹¤í–‰](#7-ì„¤ì¹˜-ë°-ì‹¤í–‰)
8. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#8-í…ŒìŠ¤íŠ¸-ë°©ë²•)
9. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#9-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)
10. [ì„±ëŠ¥ ì¸¡ì • ê³„íš](#10-ì„±ëŠ¥-ì¸¡ì •-ê³„íš)

---

## 1. ë°°ê²½ ë° ë¬¸ì œ ìƒí™©

### 1.1 ë¬¸ì œ ë°œê²¬

k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼, VU 500~1000 ê·œëª¨ì˜ ë™ì‹œ ìš”ì²­ ë°œìƒ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ê´€ì¸¡ë˜ì—ˆìŠµë‹ˆë‹¤:

```
ì¦ìƒ:
- Tomcat Accept Queue í¬í™”
- ìš”ì²­ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
- íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ë°œìƒ
- 502 Bad Gateway ì—ëŸ¬ ì¦ê°€
```

### 1.2 ê·¼ë³¸ ì›ì¸ ë¶„ì„

```
ë¬¸ì œ: "ìš”ì²­ ìœ ì… ì†ë„" > "ì²˜ë¦¬ ì†ë„"

[í´ë¼ì´ì–¸íŠ¸] 
    â†“ ì´ˆë‹¹ 1000ê°œ ìš”ì²­
[Tomcat Accept Queue] â† 100ê°œë§Œ ëŒ€ê¸° ê°€ëŠ¥ (í¬í™”)
    â†“
[Worker Thread Pool] â† ì²˜ë¦¬ ì†ë„ í•œê³„
    â†“
[Spring Boot Application]
```

**í•µì‹¬ ë¬¸ì œ:**
- **Tomcat Accept Queue**: OS ì»¤ë„ ë ˆë²¨ì˜ ì†Œì¼“ ëŒ€ê¸°ì—´
- **Worker Thread**: JVM ë ˆë²¨ì˜ ìš”ì²­ ì²˜ë¦¬ ìŠ¤ë ˆë“œ
- Accept Queueê°€ ê½‰ ì°¨ë©´ â†’ ìƒˆ ìš”ì²­ ê±°ë¶€ â†’ í´ë¼ì´ì–¸íŠ¸ëŠ” íƒ€ì„ì•„ì›ƒ

### 1.3 Virtual Threadë¡œ í•´ê²° ì•ˆ ë˜ëŠ” ì´ìœ 

Java 21ì˜ Virtual ThreadëŠ” JVM ë‚´ë¶€ Thread íš¨ìœ¨ì„ ë†’ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ:

```
Virtual Thread: JVM ë ˆë²¨ ìµœì í™”
Accept Queue: OS ì»¤ë„ ë ˆë²¨ (JVM ì§„ì… ì „)

â†’ Accept Queue ë³‘ëª©ì€ Virtual Threadë¡œ í•´ê²° ë¶ˆê°€
```

---

## 2. Nginx ë„ì… ì´ìœ 

### 2.1 Nginxê°€ í•´ê²°í•˜ëŠ” 3ê°€ì§€ ë¬¸ì œ

#### 1) ìš”ì²­ íë¦„ ì œì–´ (Traffic Shaping)

```
[Before]
Client â†’ Tomcat (ë°”ë¡œ ì „ë‹¬, ê³¼ë¶€í•˜ ì‹œ ê±°ë¶€)

[After]
Client â†’ Nginx (ë¹„ë™ê¸°ë¡œ ë¹ ë¥´ê²Œ ìˆ˜ë½)
       â†“
       Tomcat (ì²˜ë¦¬ ê°€ëŠ¥í•œ ì†ë„ë¡œ ì²œì²œíˆ ì „ë‹¬)
```

**ë¹„ìœ :**
```
ìŒì‹ì ì—ì„œ í™€ ì§ì›(Nginx)ì´ ì£¼ë¬¸ì„ ë°›ì•„ì„œ
ì£¼ë°©(Tomcat)ì— ì¡°ë¦¬ ê°€ëŠ¥í•œ ì†ë„ë¡œ ì „ë‹¬
â†’ ì£¼ë°©ì€ ì¡°ë¦¬ë§Œ ì§‘ì¤‘
```

#### 2) Connection Pooling (ì—°ê²° ì¬ì‚¬ìš©)

```
[ê¸°ì¡´ ë°©ì‹] ë§¤ë²ˆ ìƒˆ ì—°ê²°
Client 1 â†’ [3-way handshake] â†’ Tomcat (ì¢…ë£Œ)
Client 2 â†’ [3-way handshake] â†’ Tomcat (ì¢…ë£Œ)
ë¹„ìš©: TCP handshake ë¹„ìš© ë§¤ë²ˆ ë°œìƒ

[Nginx ë°©ì‹] ì—°ê²° ì¬ì‚¬ìš©
Client 1 â†’ Nginx â†’ [ì—°ê²° A ì¬ì‚¬ìš©] â†’ Tomcat
Client 2 â†’ Nginx â†’ [ì—°ê²° A ì¬ì‚¬ìš©] â†’ Tomcat
Client 3 â†’ Nginx â†’ [ì—°ê²° B ì¬ì‚¬ìš©] â†’ Tomcat
íš¨ê³¼: TCP handshake íšŸìˆ˜ 95% ê°ì†Œ
```

**ì„¤ì •:**
```nginx
keepalive 32;  # 32ê°œ ì—°ê²°ì„ í’€ì— ë³´ê´€
```

í´ë¼ì´ì–¸íŠ¸ê°€ 1000ëª…ì´ì–´ë„ â†’ Tomcatì€ 32ê°œ ì—°ê²°ë§Œ ê´€ë¦¬

#### 3) Timeout ë° Retry ì œì–´

```nginx
proxy_connect_timeout 60s;       # 60ì´ˆ ì•ˆì— ì—°ê²° ì‹¤íŒ¨ ì‹œ í¬ê¸°
proxy_next_upstream_tries 2;     # ì‹¤íŒ¨ ì‹œ 2ë²ˆ ì¬ì‹œë„
```

ì¥ì•  ì„œë²„ë¥¼ ë¹ ë¥´ê²Œ ì œì™¸í•˜ì—¬ ì „ì²´ ì‘ë‹µ ì‹œê°„ ê°œì„ 

### 2.2 ê¸°ëŒ€ íš¨ê³¼

| ì§€í‘œ | Before | After (ì˜ˆìƒ) | ê°œì„ ìœ¨ |
|-----|--------|--------------|--------|
| RPS | 500 | 800+ | +60% |
| p95 Latency | 2000ms | 500ms | -75% |
| Error Rate | 10% | 1% | -90% |

---

## 3. ì•„í‚¤í…ì²˜ ë³€ê²½

### 3.1 Before (ë¬¸ì œ ìƒí™©)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  k6 Client  â”‚ VU 500~1000
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP :8080
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tomcat :8080       â”‚
â”‚  Accept Queue í¬í™”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring Boot App     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 After (Nginx ë„ì…)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  k6 Client  â”‚ VU 500~1000
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP :80
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx :80                  â”‚
â”‚  - ë¹„ë™ê¸° I/Oë¡œ ë¹ ë¥¸ ìˆ˜ë½      â”‚
â”‚  - Connection Pooling        â”‚
â”‚  - ìš”ì²­ íë¦„ ì œì–´              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ keepalive 32ê°œ ì—°ê²°
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tomcat :8080       â”‚
â”‚  Accept Queue ì—¬ìœ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring Boot App     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Docker í™˜ê²½ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Compose Network            â”‚
â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  PostgreSQL  â”‚ :5432           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚    Nginx     â”‚ :80 (ì™¸ë¶€ ë…¸ì¶œ)  â”‚
â”‚  â”‚              â”‚ â† templates/     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚ proxy_pass               â”‚
â”‚         â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Spring Boot  â”‚ :8080 (í˜¸ìŠ¤íŠ¸)   â”‚
â”‚  â”‚ (í˜¸ìŠ¤íŠ¸ ì‹¤í–‰) â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                          â”‚
â”‚         â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  PostgreSQL  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì£¼ìš” íŠ¹ì§•:**
- Nginxì™€ PostgreSQL: Docker ì»¨í…Œì´ë„ˆ
- Spring Boot: í˜¸ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ ì‹¤í–‰ (ê°œë°œ í¸ì˜ì„±)
- `host.docker.internal`: ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ ì ‘ê·¼

---

## 4. ì£¼ìš” ê°œë… ì´í•´

### 4.1 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ (Reverse Proxy)

```
Forward Proxy (ì¼ë°˜ í”„ë¡ì‹œ):
Client â†’ Proxy â†’ Internet
(í´ë¼ì´ì–¸íŠ¸ë¥¼ ëŒ€ì‹ í•´ì„œ ìš”ì²­)

Reverse Proxy:
Client â†’ Proxy â†’ Backend Server
(ì„œë²„ë¥¼ ëŒ€ì‹ í•´ì„œ ì‘ë‹µ)
```

**Nginxì˜ ì—­í• :**
- í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ë°›ì•„ì„œ ë°±ì—”ë“œë¡œ ì „ë‹¬
- ë°±ì—”ë“œ ì‘ë‹µì„ ë°›ì•„ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬
- ì¤‘ê°„ì—ì„œ ìºì‹±, ì••ì¶•, ë¡œë“œ ë°¸ëŸ°ì‹± ë“± ìˆ˜í–‰

### 4.2 Worker í”„ë¡œì„¸ìŠ¤ & ì´ë²¤íŠ¸ ëª¨ë¸

```nginx
# nginx.conf
worker_processes auto;              # CPU ì½”ì–´ ìˆ˜ë§Œí¼ í”„ë¡œì„¸ìŠ¤ ìƒì„±

events {
    worker_connections 10000;       # ê° Workerê°€ ì²˜ë¦¬í•  ë™ì‹œ ì—°ê²° ìˆ˜
    use epoll;                      # Linux ìµœì í™” ì´ë²¤íŠ¸ ëª¨ë¸
}
```

**ê³„ì‚°:**
```
CPU 4ì½”ì–´ Ã— worker_connections 10,000 = 40,000 ë™ì‹œ ì—°ê²° ê°€ëŠ¥
```

**epoll vs select:**
```
select: ì—°ê²° í•˜ë‚˜ì”© í™•ì¸ (O(n))
epoll: ë³€ê²½ëœ ì—°ê²°ë§Œ í™•ì¸ (O(1))
â†’ 10,000ê°œ ì—°ê²° ì‹œ 100ë°° ë¹ ë¦„
```

### 4.3 Connection Pooling

```nginx
upstream spring_boot {
    server host.docker.internal:8080;
    keepalive 32;                   # ì—°ê²° í’€ í¬ê¸°
    keepalive_timeout 60s;          # ì—°ê²° ìœ ì§€ ì‹œê°„
    keepalive_requests 100;         # ì—°ê²°ë‹¹ ìµœëŒ€ ìš”ì²­ ìˆ˜
}
```

**ë™ì‘ ë°©ì‹:**
1. Nginx â†’ Tomcat ì—°ê²° 32ê°œ ë¯¸ë¦¬ ìƒì„±
2. ìš”ì²­ ë“¤ì–´ì˜¤ë©´ â†’ ê¸°ì¡´ ì—°ê²° ì¬ì‚¬ìš©
3. ì‘ë‹µ í›„ ì—°ê²° ì¢…ë£Œ ì•ˆ í•¨ â†’ í’€ì— ë°˜í™˜
4. 60ì´ˆ ë™ì•ˆ ìš”ì²­ ì—†ìœ¼ë©´ â†’ ì—°ê²° ì¢…ë£Œ

**ê¶Œì¥ê°’:**
```
keepalive = ë™ì‹œ ì²˜ë¦¬ ì˜ˆìƒì¹˜ì˜ 10-20%
VU 500 â†’ keepalive 50~100
```

### 4.4 Nginx ë³€ìˆ˜ ($host vs $http_host)

| ë³€ìˆ˜ | ê°’ | ì„¤ëª… |
|------|-----|------|
| `$host` | `timefit-nginx` | Nginx ì„œë²„ ì´ë¦„ (underscore í¬í•¨ ê°€ëŠ¥) |
| `$http_host` | `localhost` | í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ì›ë³¸ Host í—¤ë” |

**ì¤‘ìš”:** Tomcatì€ ë„ë©”ì¸ ì´ë¦„ì— underscoreë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŒ
â†’ `$http_host` ì‚¬ìš© í•„ìˆ˜

---

## 5. í”„ë¡œì íŠ¸ êµ¬ì¡°

### 5.1 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
timefit-back/
â”œâ”€â”€ .env                           # í™˜ê²½ ë³€ìˆ˜ (Git ì œì™¸)
â”œâ”€â”€ docker-compose.yml              # Docker Compose ì„¤ì •
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ nginx-guide.md             # ì´ ë¬¸ì„œ
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf                 # Nginx ì „ì—­ ì„¤ì •
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â””â”€â”€ default.conf.template  # ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • (í…œí”Œë¦¿)
â”‚   â””â”€â”€ logs/                      # Nginx ë¡œê·¸ (ìë™ ìƒì„±)
â”‚       â”œâ”€â”€ access.log
â”‚       â””â”€â”€ error.log
â”œâ”€â”€ src/
â””â”€â”€ build.gradle
```

### 5.2 Git ê´€ë¦¬

**í¬í•¨ (âœ…):**
- `docker-compose.yml`
- `nginx/nginx.conf`
- `nginx/templates/default.conf.template`

**ì œì™¸ (âŒ):**
- `.env` (ë¯¼ê° ì •ë³´)
- `nginx/logs/` (ìë™ ìƒì„±)

```gitignore
# .gitignore
../../../../../../Users/sehan/Downloads/docker-compose.yml
docker-compose.override.yml
nginx/logs/
```

---

## 6. ì„¤ì • íŒŒì¼ ìƒì„¸

### 6.1 í™˜ê²½ ë³€ìˆ˜ (.env)

```env
# Nginx Backend (dev í™˜ê²½)
# Windows/Mac Docker Desktop: host.docker.internal ì‚¬ìš©
# Linux: 172.17.0.1 ì‚¬ìš©
BACKEND_HOST=host.docker.internal
BACKEND_PORT=8080

# Nginx ìƒíƒœ í™•ì¸ ì—”ë“œí¬ì¸íŠ¸ (dev: on, prod: off)
NGINX_STATUS_ENABLED=on
```

**ì—­í• :**
- í™˜ê²½ë³„ ì„¤ì • ë¶„ë¦¬ (dev/prod)
- ê¸°ì¡´ `.env` íŒ¨í„´ê³¼ ì¼ê´€ì„± ìœ ì§€

### 6.2 Docker Compose (docker-compose.yml)

```yaml
services:
  nginx:
    image: nginx:latest
    container_name: timefit-nginx
    ports:
      - "80:80"
    volumes:
      # ì „ì—­ ì„¤ì • íŒŒì¼
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # í…œí”Œë¦¿ íŒŒì¼ (í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜)
      - ./nginx/templates:/etc/nginx/templates:ro
      # ë¡œê·¸ íŒŒì¼
      - ./nginx/logs:/var/log/nginx
    environment:
      - BACKEND_HOST=${BACKEND_HOST}
      - BACKEND_PORT=${BACKEND_PORT}
      - NGINX_STATUS_ENABLED=${NGINX_STATUS_ENABLED}
    depends_on:
      - db
    networks:
      - timefit-network
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- `templates:ro`: í…œí”Œë¦¿ íŒŒì¼ì€ ì½ê¸° ì „ìš©
- Nginx ê³µì‹ ì´ë¯¸ì§€ê°€ ìë™ìœ¼ë¡œ `.template` íŒŒì¼ ì²˜ë¦¬
- í™˜ê²½ ë³€ìˆ˜ë¡œ ì¹˜í™˜ í›„ `/etc/nginx/conf.d/*.conf` ìƒì„±

### 6.3 Nginx ì „ì—­ ì„¤ì • (nginx.conf)

```nginx
user nginx;
worker_processes auto;              # CPU ì½”ì–´ ìˆ˜ë§Œí¼ ìë™ í• ë‹¹
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 10000;       # Worker í”„ë¡œì„¸ìŠ¤ë‹¹ ìµœëŒ€ ë™ì‹œ ì—°ê²° ìˆ˜
    multi_accept on;                # ì—¬ëŸ¬ ì—°ê²°ì„ í•œ ë²ˆì— ìˆ˜ë½
    use epoll;                      # Linux ìµœì í™” ì´ë²¤íŠ¸ ëª¨ë¸
}

http {
    # ë¡œê·¸ í¬ë§· (ì„±ëŠ¥ ì¸¡ì •ìš©)
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # ì„±ëŠ¥ ìµœì í™”
    sendfile on;                    # íŒŒì¼ ì „ì†¡ ìµœì í™”
    tcp_nopush on;                  # íŒ¨í‚· íš¨ìœ¨í™”
    tcp_nodelay on;                 # ì§€ì—° ì—†ì´ ì „ì†¡
    keepalive_timeout 65;           # Keep-Alive ì—°ê²° ìœ ì§€ ì‹œê°„

    # Gzip ì••ì¶•
    gzip on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript;

    # ì‚¬ì´íŠ¸ë³„ ì„¤ì • í¬í•¨
    include /etc/nginx/conf.d/*.conf;
}
```

**ì£¼ìš” ì„¤ì • ì„¤ëª…:**

| ì„¤ì • | ê°’ | ì˜ë¯¸ |
|------|-----|------|
| `worker_processes` | `auto` | CPU ì½”ì–´ ìˆ˜ë§Œí¼ í”„ë¡œì„¸ìŠ¤ ìƒì„± |
| `worker_connections` | `10000` | ê° Workerê°€ ì²˜ë¦¬í•  ë™ì‹œ ì—°ê²° ìˆ˜ |
| `multi_accept` | `on` | í•œ ë²ˆì— ì—¬ëŸ¬ ì—°ê²° ìˆ˜ë½ (íš¨ìœ¨ ì¦ê°€) |
| `use epoll` | `epoll` | Linux ìµœì í™” ì´ë²¤íŠ¸ ëª¨ë¸ (O(1)) |
| `sendfile` | `on` | ì»¤ë„ ë ˆë²¨ íŒŒì¼ ì „ì†¡ (ì„±ëŠ¥ í–¥ìƒ) |
| `gzip` | `on` | ì‘ë‹µ ì••ì¶• (ì „ì†¡ëŸ‰ ê°ì†Œ) |

### 6.4 ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • (default.conf.template)

```nginx
# Upstream: Spring Boot ë°±ì—”ë“œ ì„œë²„ ì •ì˜
upstream spring_boot {
    # í™˜ê²½ ë³€ìˆ˜ë¡œ ë°±ì—”ë“œ ì£¼ì†Œ ë™ì  ì„¤ì •
    server ${BACKEND_HOST}:${BACKEND_PORT} max_fails=3 fail_timeout=30s;
    
    # Connection Pooling ì„¤ì •
    keepalive 32;                   # ì¬ì‚¬ìš©í•  ì—°ê²° ìˆ˜
    keepalive_timeout 60s;          # ì—°ê²° ìœ ì§€ ì‹œê°„
    keepalive_requests 100;         # ì—°ê²°ë‹¹ ìµœëŒ€ ìš”ì²­ ìˆ˜
}

server {
    listen 80;
    server_name localhost;

    # ëª¨ë“  ìš”ì²­ì„ Spring Bootë¡œ í”„ë¡ì‹œ
    location / {
        proxy_pass http://spring_boot;

        # HTTP ë²„ì „ ë° ì—°ê²° ìœ ì§€
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # í´ë¼ì´ì–¸íŠ¸ ì •ë³´ í—¤ë” ì „ë‹¬
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ë²„í¼ ì„¤ì • (ì„±ëŠ¥ ìµœì í™”)
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
    location /health {
        access_log off;
        proxy_pass http://spring_boot/actuator/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $http_host;
    }

    # Nginx ìƒíƒœ í™•ì¸ (ê°œë°œ í™˜ê²½ìš©)
    location /nginx_status {
        stub_status ${NGINX_STATUS_ENABLED};
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
```

**ì£¼ìš” ì„¤ì • ì„¤ëª…:**

| ì„¤ì • | ê°’ | ì˜ë¯¸ |
|------|-----|------|
| `proxy_http_version` | `1.1` | HTTP/1.1 Keep-Alive í™œì„±í™” |
| `Connection ""` | ë¹ˆ ë¬¸ìì—´ | Nginxê°€ Connection í—¤ë” ê´€ë¦¬ |
| `Host $http_host` | í´ë¼ì´ì–¸íŠ¸ í—¤ë” | Tomcatì˜ underscore ì œí•œ ìš°íšŒ |
| `X-Forwarded-For` | í´ë¼ì´ì–¸íŠ¸ IP | ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IP ì „ë‹¬ |
| `proxy_buffering on` | ë²„í¼ë§ í™œì„±í™” | ë°±ì—”ë“œ ë¶€í•˜ ê°ì†Œ |

---

## 7. ì„¤ì¹˜ ë° ì‹¤í–‰

### 7.1 ì‚¬ì „ ì¤€ë¹„

**í•„ìš” ë„êµ¬:**
- Docker Desktop (Windows/Mac)
- Docker Compose
- Git

**í™•ì¸:**
```bash
docker --version
docker-compose --version
```

### 7.2 ì´ˆê¸° ì„¤ì • (ìµœì´ˆ 1íšŒ)

#### 1) í´ë” ìƒì„±
```bash
cd timefit-back
mkdir -p nginx/templates nginx/logs
```

#### 2) í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```bash
# .env íŒŒì¼ì— ì¶”ê°€
BACKEND_HOST=host.docker.internal
BACKEND_PORT=8080
NGINX_STATUS_ENABLED=on
```

**Linux ì‚¬ìš©ì:**
```env
# LinuxëŠ” host.docker.internal ë¯¸ì§€ì›
BACKEND_HOST=172.17.0.1
BACKEND_PORT=8080
```

#### 3) íŒŒì¼ ë°°ì¹˜ í™•ì¸
```
âœ… .env
âœ… docker-compose.yml
âœ… nginx/nginx.conf
âœ… nginx/templates/default.conf.template
```

### 7.3 ì‹¤í–‰

```bash
# 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
docker-compose down

# 2. ìƒˆ ì„¤ì •ìœ¼ë¡œ ì‹œì‘
docker-compose up -d

# 3. ë¡œê·¸ í™•ì¸
docker-compose logs -f nginx
```

**ì˜ˆìƒ ë¡œê·¸:**
```
timefit-nginx  | /docker-entrypoint.sh: Configuration complete; ready for start up
```

### 7.4 Spring Boot ì‹¤í–‰

**ë³„ë„ í„°ë¯¸ë„ì—ì„œ:**
```bash
# Gradle
./gradlew bootRun

# ë˜ëŠ” IntelliJì—ì„œ ì‹¤í–‰
```

### 7.5 ìƒíƒœ í™•ì¸

```bash
# Docker ì»¨í…Œì´ë„ˆ í™•ì¸
docker ps

# Nginx í”„ë¡œì„¸ìŠ¤ í™•ì¸
docker exec timefit-nginx ps aux

# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
docker exec timefit-nginx env | grep BACKEND
```

---

## 8. í…ŒìŠ¤íŠ¸ ë°©ë²•

### 8.1 PowerShell í…ŒìŠ¤íŠ¸

```powershell
# 1. Spring Boot ì§ì ‘ ì—°ê²° (8080)
curl.exe http://localhost:8080/actuator/health

# 2. Nginx ê²½ìœ  - ì§§ì€ ê²½ë¡œ (80)
curl.exe http://localhost/health

# 3. Nginx ê²½ìœ  - ì „ì²´ ê²½ë¡œ (80)
curl.exe http://localhost/actuator/health
```

**ì˜ˆìƒ ê²°ê³¼:**
```json
{"status":"UP","components":{"db":{"status":"UP"}}}
```

### 8.2 ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸

**ì£¼ì†Œì°½ì— ì…ë ¥:**
```
http://localhost/health
http://localhost/api/v1/menu/list
```

**ê°œë°œì ë„êµ¬ (F12) â†’ Network íƒ­:**
```
Response Headers:
  Server: nginx/1.29.5  â† Nginxë¥¼ í†µí•´ ì‘ë‹µ
  X-Forwarded-For: ...  â† í´ë¼ì´ì–¸íŠ¸ IP
```

### 8.3 ë¸Œë¼ìš°ì € ì½˜ì†” í…ŒìŠ¤íŠ¸

```javascript
// F12 â†’ Console íƒ­ì— ë¶™ì—¬ë„£ê¸°
fetch('http://localhost/health')
  .then(res => res.json())
  .then(data => console.log('âœ… í—¬ìŠ¤ì²´í¬:', data.status));

fetch('http://localhost/api/v1/menu/list')
  .then(res => res.json())
  .then(data => {
    console.log('âœ… API ì„±ê³µ');
    console.table(data.content?.slice(0, 5));
  });
```

### 8.4 ì„±ëŠ¥ ê°„ì´ ì¸¡ì •

```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”
async function compare() {
  console.time('Tomcat ì§ì ‘');
  for (let i = 0; i < 10; i++) {
    await fetch('http://localhost:8080/actuator/health');
  }
  console.timeEnd('Tomcat ì§ì ‘');
  
  console.time('Nginx ê²½ìœ ');
  for (let i = 0; i < 10; i++) {
    await fetch('http://localhost/health');
  }
  console.timeEnd('Nginx ê²½ìœ ');
}
compare();
```

### 8.5 ë¡œê·¸ í™•ì¸

```bash
# ì‹¤ì‹œê°„ ì ‘ê·¼ ë¡œê·¸
tail -f nginx/logs/access.log

# ì‹¤ì‹œê°„ ì—ëŸ¬ ë¡œê·¸
tail -f nginx/logs/error.log

# Docker ë¡œê·¸
docker logs -f timefit-nginx
```

**ë¡œê·¸ í¬ë§·:**
```
127.0.0.1 - - [07/Feb/2025:10:30:00 +0000] "GET /health HTTP/1.1" 200 50
rt=0.015 uct="0.001" uht="0.010" urt="0.015"
```

**ì£¼ìš” ì§€í‘œ:**
- `rt`: ì „ì²´ ìš”ì²­ ì‹œê°„ (Request Time)
- `uct`: ë°±ì—”ë“œ ì—°ê²° ì‹œê°„ (Upstream Connect Time)
- `uht`: ë°±ì—”ë“œ í—¤ë” ìˆ˜ì‹  ì‹œê°„ (Upstream Header Time)
- `urt`: ë°±ì—”ë“œ ì‘ë‹µ ì‹œê°„ (Upstream Response Time)

---

## 9. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 9.1 502 Bad Gateway

**ì¦ìƒ:**
```html
<h1>502 Bad Gateway</h1>
<center>nginx/1.29.5</center>
```

**ì›ì¸:**
1. Spring Bootê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì˜¤ë¥˜
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨

**í•´ê²°:**
```bash
# 1. Spring Boot ìƒíƒœ í™•ì¸
curl http://localhost:8080/actuator/health

# ì•ˆ ë˜ë©´ Spring Boot ì‹¤í–‰
./gradlew bootRun

# 2. í™˜ê²½ ë³€ìˆ˜ í™•ì¸
docker exec timefit-nginx env | grep BACKEND

# 3. ìƒì„±ëœ ì„¤ì • íŒŒì¼ í™•ì¸
docker exec timefit-nginx cat /etc/nginx/conf.d/default.conf

# 4. Nginx ì—ëŸ¬ ë¡œê·¸
tail -f nginx/logs/error.log
```

### 9.2 400 Bad Request - Underscore in Domain

**ì¦ìƒ:**
```
The character [_] is never valid in a domain name.
```

**ì›ì¸:**
```nginx
# ì˜ëª»ëœ ì„¤ì •
proxy_set_header Host $host;  # timefit-nginx (underscore í¬í•¨)
```

**í•´ê²°:**
```nginx
# ì˜¬ë°”ë¥¸ ì„¤ì •
proxy_set_header Host $http_host;  # localhost (í´ë¼ì´ì–¸íŠ¸ ì›ë³¸)
```

### 9.3 403 Forbidden (nginx_status)

**ì¦ìƒ:**
```
curl http://localhost/nginx_status
â†’ 403 Forbidden
```

**ì›ì¸:**
```nginx
location /nginx_status {
    allow 127.0.0.1;  # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë§Œ í—ˆìš©
    deny all;
}
```

**í•´ê²°:**
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ í™•ì¸
docker exec timefit-nginx curl http://127.0.0.1/nginx_status
```

**ì˜ˆìƒ ì¶œë ¥:**
```
Active connections: 5
server accepts handled requests
 123 123 456
Reading: 0 Writing: 1 Waiting: 4
```

### 9.4 í™˜ê²½ ë³€ìˆ˜ ë°˜ì˜ ì•ˆ ë¨

**ì¦ìƒ:**
```bash
# ìƒì„±ëœ ì„¤ì • íŒŒì¼ì— í™˜ê²½ ë³€ìˆ˜ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆìŒ
server ${BACKEND_HOST}:${BACKEND_PORT};
```

**ì›ì¸:**
- ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ë§Œ í–ˆìŒ (ì¬ìƒì„± í•„ìš”)
- í…œí”Œë¦¿ íŒŒì¼ ìœ„ì¹˜ ì˜¤ë¥˜

**í•´ê²°:**
```bash
# ì»¨í…Œì´ë„ˆ ì¬ìƒì„±
docker-compose down
docker-compose up -d --force-recreate

# í…œí”Œë¦¿ íŒŒì¼ ìœ„ì¹˜ í™•ì¸
ls nginx/templates/default.conf.template

# í™•ì¥ì í™•ì¸ (.template í•„ìˆ˜)
```

### 9.5 Connection Refused

**ì¦ìƒ:**
```
curl: (7) Failed to connect to localhost port 80
```

**ì›ì¸:**
- Nginx ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- í¬íŠ¸ 80ì´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì‚¬ìš© ì¤‘

**í•´ê²°:**
```bash
# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps | grep nginx

# ì—†ìœ¼ë©´ ì¬ì‹œì‘
docker-compose up -d

# í¬íŠ¸ ì‚¬ìš© í™•ì¸ (Windows)
netstat -ano | findstr :80
```

---

## 10. ì„±ëŠ¥ ì¸¡ì • ê³„íš

### 10.1 ì¸¡ì • ëª©í‘œ

**ëª©ì :**
- Nginx ë„ì… ì „í›„ ì„±ëŠ¥ ë¹„êµ
- Connection Pooling íš¨ê³¼ ê²€ì¦
- í¬íŠ¸í´ë¦¬ì˜¤ ì œì‹œìš© ì •ëŸ‰ì  ì§€í‘œ í™•ë³´

**ì¸¡ì • ë„êµ¬:**
- k6: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬
- Nginx Access Log: ì‘ë‹µ ì‹œê°„ ì¸¡ì •

### 10.2 í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```javascript
// k6 ìŠ¤í¬ë¦½íŠ¸ (ì˜ˆì •)

// Before: Tomcat ì§ì ‘ ì ‘ê·¼
export default function() {
  http.get('http://localhost:8080/api/v1/menu/list');
}

// After: Nginx ê²½ìœ 
export default function() {
  http.get('http://localhost/api/v1/menu/list');
}
```

**í…ŒìŠ¤íŠ¸ ì¡°ê±´:**
- Virtual Users: 500~1000
- Duration: 30ì´ˆ
- Ramp-up: 10ì´ˆ

### 10.3 ì¸¡ì • ì§€í‘œ

| ì§€í‘œ | ì„¤ëª… | ëª©í‘œ |
|------|------|------|
| RPS | ì´ˆë‹¹ ì²˜ë¦¬ ìš”ì²­ ìˆ˜ | +60% í–¥ìƒ |
| p50 Latency | ì¤‘ì•™ê°’ ì‘ë‹µ ì‹œê°„ | -50% ê°œì„  |
| p95 Latency | 95% ì‘ë‹µ ì‹œê°„ | -75% ê°œì„  |
| p99 Latency | 99% ì‘ë‹µ ì‹œê°„ | -80% ê°œì„  |
| Error Rate | ì—ëŸ¬ ë°œìƒë¥  | -90% ê°ì†Œ |

### 10.4 ë‹¤ìŒ ë‹¨ê³„

1. k6 í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
2. Before ì„±ëŠ¥ ì¸¡ì • (Tomcat ì§ì ‘)
3. After ì„±ëŠ¥ ì¸¡ì • (Nginx ê²½ìœ )
4. ê²°ê³¼ ë¹„êµ ë° ë¶„ì„
5. ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

## 11. ì°¸ê³  ìë£Œ

### 11.1 ê³µì‹ ë¬¸ì„œ

- [Nginx ê³µì‹ ë¬¸ì„œ](https://nginx.org/en/docs/)
- [Nginx Docker ì´ë¯¸ì§€](https://hub.docker.com/_/nginx)
- [Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ê°€ì´ë“œ](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)

### 11.2 ì£¼ìš” ê°œë…

- **ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ**: í´ë¼ì´ì–¸íŠ¸ ì•ì—ì„œ ì„œë²„ë¥¼ ëŒ€ì‹ í•˜ëŠ” í”„ë¡ì‹œ
- **Connection Pooling**: ì—°ê²°ì„ ì¬ì‚¬ìš©í•˜ì—¬ TCP handshake ë¹„ìš© ì ˆê°
- **Worker í”„ë¡œì„¸ìŠ¤**: Nginxì˜ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ ë‹¨ìœ„
- **epoll**: Linux ì»¤ë„ì˜ íš¨ìœ¨ì ì¸ I/O ì´ë²¤íŠ¸ ì•Œë¦¼ ë©”ì»¤ë‹ˆì¦˜

### 11.3 ìœ ìš©í•œ ëª…ë ¹ì–´

```bash
# Nginx ì„¤ì • ë¬¸ë²• ê²€ì‚¬
docker exec timefit-nginx nginx -t

# Nginx ë¦¬ë¡œë“œ (ì—°ê²° ìœ ì§€)
docker exec timefit-nginx nginx -s reload

# Nginx ìƒíƒœ í™•ì¸
docker exec timefit-nginx curl http://127.0.0.1/nginx_status

# ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
docker logs -f timefit-nginx
```

---

## 12. í–¥í›„ ê°œì„  ì‚¬í•­

### 12.1 HTTPS ì ìš© (Phase 2)

```nginx
server {
    listen 443 ssl;
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
}
```

**ì¤€ë¹„ ì‚¬í•­:**
- Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰
- ë„ë©”ì¸ ì—°ê²°
- í”„ë¡ íŠ¸ì—”ë“œ URL ë³€ê²½ (https://)

### 12.2 Rate Limiting (ê³¼ë¶€í•˜ ë°©ì§€)

```nginx
limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;

location /api {
    limit_req zone=one burst=20;
}
```

**íš¨ê³¼:**
- í´ë¼ì´ì–¸íŠ¸ë‹¹ ì´ˆë‹¹ 10ê°œ ìš”ì²­ ì œí•œ
- Burst: ìˆœê°„ì ìœ¼ë¡œ 20ê°œê¹Œì§€ í—ˆìš©

### 12.3 ìºì‹± (ì •ì  ì»¨í…ì¸ )

```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m;

location /api/v1/menu/list {
    proxy_cache my_cache;
    proxy_cache_valid 200 5m;
}
```

**íš¨ê³¼:**
- ë™ì¼í•œ ìš”ì²­ì„ 5ë¶„ê°„ ìºì‹±
- ë°±ì—”ë“œ ë¶€í•˜ ê°ì†Œ

### 12.4 ë¡œë“œ ë°¸ëŸ°ì‹± (ë‹¤ì¤‘ ì„œë²„)

```nginx
upstream spring_boot {
    server app1:8080;
    server app2:8080;
    server app3:8080;
}
```

**íš¨ê³¼:**
- ì—¬ëŸ¬ Spring Boot ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¶„ì‚°
- ê³ ê°€ìš©ì„± í™•ë³´

---

## 13. ê²°ë¡ 

### 13.1 í•µì‹¬ ì„±ê³¼

1. **Tomcat Accept Queue ë³‘ëª© í•´ì†Œ**
   - Nginx ë¹„ë™ê¸° I/Oë¡œ ë¹ ë¥¸ ìš”ì²­ ìˆ˜ë½
   - Connection Poolingìœ¼ë¡œ TCP handshake 95% ê°ì†Œ

2. **ì¼ê´€ëœ í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**
   - ê¸°ì¡´ `.env` íŒ¨í„´ í™œìš©
   - dev/prod í™˜ê²½ ë¶„ë¦¬ ì¤€ë¹„

3. **Docker ê¸°ë°˜ ì¸í”„ë¼**
   - ì¬í˜„ ê°€ëŠ¥í•œ í™˜ê²½ êµ¬ì¶•
   - íŒ€ì› ì˜¨ë³´ë”© ê°„ì†Œí™”

### 13.2 ë°°ìš´ ì 

- Nginxì˜ ì—­í• ê³¼ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ê°œë…
- Connection Poolingì˜ ì¤‘ìš”ì„±
- OS ë ˆë²¨ vs JVM ë ˆë²¨ ë³‘ëª©ì˜ ì°¨ì´
- í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • ê´€ë¦¬
- Docker ë„¤íŠ¸ì›Œí‚¹ (`host.docker.internal`)

