# 메뉴 등록 시 BookingSlot 생성 명세서

---

## 1. 개요

본 문서는 Timefit 예약 관리 시스템에서 메뉴(Menu) 등록 시 예약 슬롯(BookingSlot)이 자동 생성되는 과정과 검증 규칙을 정의한다.

BookingSlot은 고객이 실제로 예약할 수 있는 구체적인 시간 단위이며, 메뉴의 소요 시간(durationMinutes)과 영업 가능 시간대(OperatingHours)를 기반으로 자동 생성된다. 본 명세서는 슬롯 생성의 정확성과 일관성을 보장하여, 예약 시스템의 안정적인 운영을 지원한다.

**적용 범위:**
- 예약형(RESERVATION_BASED) 메뉴 등록 시 BookingSlot 자동 생성
- 슬롯 생성 조건 및 검증
- 메뉴별 슬롯 중복 방지
- 메뉴 수정 시 BookingSlot 재생성 규칙
- BookingSlot 생명주기 및 상태 관리
- Reservation과의 관계 및 충돌 처리

---

## 2. 용어 정의

### 2.1 메뉴 주문 유형

메뉴는 주문 방식에 따라 두 가지 유형으로 구분된다.

| 유형 | 영문 코드 | 설명 | BookingSlot 생성 |
|------|----------|------|-----------------|
| 예약형 | RESERVATION_BASED | 시간대를 지정하여 사전 예약하는 서비스 | ✅ 자동 생성 |
| 주문형 | ONDEMAND_BASED | 즉시 주문/배달 방식의 서비스 | ❌ 생성 안 함 |

**예시:**
- **예약형**: 헤어컷(60분), 파마(120분), 레스토랑 테이블 예약
- **주문형**: 배달 음식, 택배, 즉석 주문 상품

---

### 2.2 BookingSlot

**정의:**

고객이 실제로 예약할 수 있는 구체적인 시간 단위. 하나의 슬롯은 특정 날짜, 시작 시간, 종료 시간을 가진다.

**구성 요소:**

| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| slotId | UUID | 슬롯 고유 식별자 | 550e8400-... |
| menuId | UUID | 메뉴 ID (외래키) | 30000000-... |
| businessId | UUID | 업체 ID (외래키) | 10000000-... |
| slotDate | LocalDate | 예약 날짜 | 2026-01-16 |
| startTime | LocalTime | 시작 시간 | 09:00 |
| endTime | LocalTime | 종료 시간 | 10:00 |
| isAvailable | Boolean | 예약 가능 여부 | true |
| status | BookingStatus | 슬롯 상태 | AVAILABLE |

---

### 2.3 슬롯 간격 (Slot Interval)

**정의:**

BookingSlot이 생성되는 시간 간격. 메뉴의 소요 시간(durationMinutes)과 동일하거나 더 작은 값으로 설정된다.

**설정 방식:**

```
slotIntervalMinutes = durationMinutes (기본값)
```

**예시:**

| 메뉴 | 소요 시간 | 슬롯 간격 | 생성되는 슬롯 (09:00-12:00) |
|------|----------|----------|---------------------------|
| 헤어컷 | 60분 | 60분 | 09:00, 10:00, 11:00 |
| 파마 | 120분 | 120분 | 09:00 (1개만) |
| 상담 | 30분 | 30분 | 09:00, 09:30, 10:00, 10:30, 11:00, 11:30 |

---

### 2.4 중복 방지 기준

**중복 체크 기준:**

```
menu_id + slotDate + startTime 조합이 동일하면 중복으로 판단
```

**목적:**

같은 메뉴의 동일 날짜/시간 슬롯이 중복 생성되는 것을 방지하되, 다른 메뉴의 슬롯은 같은 시간대에 공존할 수 있도록 허용한다.

**예시:**

```
2026-01-16 09:00 시간대:
├─ 헤어컷 슬롯: 09:00-10:00 ✅ (menu_id=A)
└─ 파마 슬롯:   09:00-11:00 ✅ (menu_id=B)

→ 같은 시간대에 다른 메뉴 슬롯 공존 가능
→ 각 메뉴별로 독립적인 예약 관리
```

**중요:**

BookingSlot 레벨에서는 menu_id로 구분하여 중복만 방지하고, 실제 예약 시간 충돌은 Reservation 생성 시점에 별도로 검증한다.

```
BookingSlot 검증: 메뉴별 슬롯 중복 방지
  ↓
Reservation 검증: 시간대 충돌 검증

예시:
  파마 09:00-11:00 예약 생성 (고객 A)
  → 헤어컷 09:00-10:00 예약 시도 (고객 B)
  → ❌ 시간 충돌로 예약 거부
```

---

## 3. 데이터 구조

### 3.1 계층 관계

BookingSlot 생성은 3개 계층의 데이터를 기반으로 한다.

```
Level 1: 예약 가능 시간대 (OperatingHours)
         │
         │ 제약: BookingSlot ⊆ OperatingHours
         ↓
Level 2: 메뉴 (Menu)
         │ - orderType: RESERVATION_BASED
         │ - durationMinutes: 슬롯 소요 시간
         │
         │ 생성 기준: menu_id + slotDate + startTime
         ↓
Level 3: 예약 슬롯 (BookingSlot)
         │
         │ 제약: 유효한 슬롯만 예약 가능
         ↓
Level 4: 고객 예약 (Reservation)
```

**계층별 역할:**

| 계층 | 명칭 | 역할 | 예시 |
|------|------|------|------|
| Level 1 | OperatingHours | 업체 전체의 예약 가능 시간대 정의 | 월요일 09:00~12:00, 13:00~18:00 |
| Level 2 | Menu | 서비스 종류 및 소요 시간 정의 | 헤어컷(60분), 파마(120분) |
| Level 3 | BookingSlot | 메뉴별 예약 가능한 구체적 슬롯 | 헤어컷: 09:00, 10:00, 11:00... |
| Level 4 | Reservation | 고객의 실제 예약 | A고객: 2026-01-16 09:00 헤어컷 |

---

### 3.2 생성 흐름도

```
[메뉴 등록 요청]
         ↓
    orderType 확인
         ↓
  RESERVATION_BASED?
    /            \
  NO             YES
   ↓              ↓
[생성 안 함]  [자동 생성 시작]
               ↓
         날짜 범위 확인
         (startDate ~ endDate)
               ↓
         각 날짜별 처리
               ↓
      해당 요일 OperatingHours 조회
               ↓
      예약 가능 시간대별 슬롯 생성
         (slotIntervalMinutes 간격)
               ↓
        중복 체크 (menu_id 기준)
         /            \
     중복 있음      중복 없음
        ↓              ↓
     [Skip]       [생성 및 저장]
               ↓
          saveAllAndFlush()
               ↓
         [생성 완료]
```

---

## 4. 생성 규칙

### 4.1 자동 생성 조건

**규칙 BS-01: 주문 유형 확인**

BookingSlot은 예약형 메뉴에만 자동 생성된다.

| orderType | 자동 생성 | 사유 |
|-----------|----------|------|
| RESERVATION_BASED | ✅ 생성 | 시간대 지정 필요 |
| ONDEMAND_BASED | ❌ 생성 안 함 | 즉시 주문 방식 |

---

**규칙 BS-02: 필수 파라미터**

자동 생성을 위해 다음 파라미터가 필수로 입력되어야 한다.

| 파라미터 | 타입 | 설명 | 예시 |
|---------|------|------|------|
| autoGenerateSlots | Boolean | 자동 생성 활성화 | true |
| startDate | LocalDate | 시작 날짜 | 2026-01-16 |
| endDate | LocalDate | 종료 날짜 | 2026-01-31 |
| slotIntervalMinutes | Integer | 슬롯 간격 (분) | 60 |

**검증:**

```java
if (request.autoGenerateSlots() == true) {
    if (slotSettings == null) {
        throw new ValidationException("슬롯 설정이 필요합니다");
    }
    if (slotSettings.startDate() == null 
        || slotSettings.endDate() == null
        || slotSettings.slotIntervalMinutes() == null) {
        throw new ValidationException("날짜 범위 및 슬롯 간격을 입력해주세요");
    }
}
```

---

### 4.2 날짜 범위 검증

**규칙 BS-03: 날짜 순서**

종료 날짜는 시작 날짜보다 늦거나 같아야 한다.

```
조건: endDate ≥ startDate
```

| 시작 날짜 | 종료 날짜 | 결과 | 사유 |
|----------|----------|------|------|
| 2026-01-16 | 2026-01-31 | ✅ 정상 | 15일 기간 |
| 2026-01-16 | 2026-01-16 | ✅ 정상 | 단일 날짜 |
| 2026-01-31 | 2026-01-16 | ❌ 오류 | 역순 |

**오류 메시지:**
```
"종료 날짜는 시작 날짜보다 늦어야 합니다."
```

---

**규칙 BS-04: 날짜 범위 제한 (권장)**

과도한 슬롯 생성을 방지하기 위해 날짜 범위를 제한한다.

| 항목 | 제한 | 사유 |
|------|------|------|
| 최대 범위 | 90일 (3개월) | DB 부하 방지 |
| 최소 범위 | 1일 | 유효성 보장 |

**예시:**

| 시작 | 종료 | 기간 | 결과 | 권장 사항 |
|------|------|------|------|----------|
| 2026-01-16 | 2026-01-31 | 15일 | ✅ 정상 | - |
| 2026-01-16 | 2026-02-28 | 43일 | ✅ 정상 | - |
| 2026-01-16 | 2026-04-30 | 104일 | ⚠️ 경고 | 90일 이내 권장 |

---

### 4.3 슬롯 간격 검증

**규칙 BS-05: 슬롯 간격 범위**

슬롯 간격은 메뉴 소요 시간 이하여야 한다.

```
조건: slotIntervalMinutes ≤ durationMinutes
```

| 소요 시간 | 슬롯 간격 | 결과 | 사유 |
|----------|----------|------|------|
| 60분 | 30분 | ✅ 정상 | 30분마다 예약 가능 (중복 예약) |
| 60분 | 60분 | ✅ 정상 | 60분마다 예약 가능 (기본) |
| 60분 | 90분 | ❌ 오류 | 간격이 소요 시간보다 큼 |

**권장 설정:**

```
slotIntervalMinutes = durationMinutes (1:1 매칭)
```

**오류 메시지:**
```
"슬롯 간격(90분)은 소요 시간(60분)보다 클 수 없습니다."
```

---

### 4.4 중복 방지 규칙

**규칙 BS-06: menu_id 기준 중복 체크**

같은 메뉴의 동일 날짜/시간 슬롯은 중복 생성되지 않는다.

```
중복 판정 기준:
  menu_id + slotDate + startTime 조합이 동일
```

**중복 체크 로직:**

```
기존 슬롯 존재 확인:
  WHERE menu_id = ? 
    AND slot_date = ?
    AND start_time = ?

결과:
  - 존재함 → Skip (생성하지 않음)
  - 존재하지 않음 → 생성
```

**다른 메뉴와의 관계:**

```
2026-01-16 09:00:
├─ 헤어컷 (menu_id=A): 09:00-10:00 ✅
└─ 파마 (menu_id=B):   09:00-11:00 ✅

→ menu_id가 다르므로 각각 생성 가능
```

---

### 4.5 예약 가능 시간대 기반 생성

**규칙 BS-07: OperatingHours 제약**

BookingSlot은 해당 요일의 예약 가능 시간대(OperatingHours) 내에서만 생성된다.

```
조건: BookingSlot ⊆ OperatingHours
```

**예시 1: 단일 시간대**

```
월요일 OperatingHours:
  09:00 ──────────────── 18:00

헤어컷 메뉴 (60분, 슬롯 간격 60분):
  09:00, 10:00, 11:00, 12:00, 13:00, 14:00, 15:00, 16:00, 17:00
  (총 9개 슬롯)
```

**예시 2: 브레이크타임 (복수 시간대)**

```
월요일 OperatingHours:
  09:00 ──── 12:00  (오전)
  13:00 ──── 18:00  (오후)
  12:00 ~ 13:00 = 브레이크타임 (생성 제외)

헤어컷 메뉴 (60분, 슬롯 간격 60분):
  오전: 09:00, 10:00, 11:00 (3개)
  오후: 13:00, 14:00, 15:00, 16:00, 17:00 (5개)
  (총 8개 슬롯, 12:00 제외)
```

---

**규칙 BS-08: 종료 시간 초과 방지**

슬롯의 종료 시간이 예약 가능 시간대를 초과하면 생성하지 않는다.

```
조건: BookingSlot.endTime ≤ OperatingHours.closeTime
```

**예시:**

```
OperatingHours: 09:00 ──── 12:00

파마 메뉴 (120분, 슬롯 간격 120분):
  시도 1: 09:00-11:00 ✅ (11:00 ≤ 12:00)
  시도 2: 10:00-12:00 ✅ (12:00 ≤ 12:00)
  시도 3: 11:00-13:00 ❌ (13:00 > 12:00) → Skip
```

**처리 방식:**

```java
LocalTime candidateEndTime = candidateStartTime.plusMinutes(durationMinutes);

if (candidateEndTime.isAfter(operatingHours.getCloseTime())) {
    log.debug("종료 시간 초과 Skip: {}~{} (영업종료: {})",
        candidateStartTime, candidateEndTime, operatingHours.getCloseTime());
    continue; // 생성하지 않고 다음으로
}
```

---

### 4.6 트랜잭션 보장

**규칙 BS-09: 즉시 커밋**

BookingSlot 대량 생성 시 트랜잭션이 즉시 커밋되어야 한다.

| 방식 | 커밋 시점 | 조회 가능 시점 | 권장 |
|------|----------|---------------|------|
| saveAll() | 트랜잭션 종료 시 | 트랜잭션 종료 후 | ❌ |
| saveAllAndFlush() | 즉시 | 즉시 | ✅ |

**사유:**

대량의 슬롯 생성 후 즉시 조회하거나 다른 작업을 수행할 수 있어야 하므로, 명시적인 flush가 필요하다.

---

## 5. 생성 프로세스

### 5.1 전체 프로세스

```
[1단계] 메뉴 검증
  ├─ orderType 확인
  ├─ autoGenerateSlots 확인
  └─ slotSettings 검증
         ↓
[2단계] 날짜 범위 생성
  ├─ startDate ~ endDate 순회
  └─ 각 날짜의 요일 확인 (DayOfWeek)
         ↓
[3단계] 예약 가능 시간대 조회
  ├─ 해당 요일의 OperatingHours 조회
  ├─ isClosed=true 확인 (휴무일 제외)
  └─ 복수 시간대 처리 (브레이크타임)
         ↓
[4단계] 슬롯 생성 (시간대별)
  ├─ startTime부터 slotIntervalMinutes 간격으로 순회
  ├─ 종료 시간 계산: endTime = startTime + durationMinutes
  ├─ 종료 시간 초과 체크: endTime ≤ closeTime
  └─ 중복 체크: menu_id + slotDate + startTime
         ↓
[5단계] DB 저장
  ├─ 생성된 슬롯 목록 수집
  ├─ saveAllAndFlush() 호출
  └─ 로그 출력: "BookingSlot 생성 완료: 생성 개수=XXX"
```

---

## 6. 검증 시나리오

### 6.1 정상 케이스

#### 시나리오 1: 기본 슬롯 생성

**상황:**
- 메뉴: 헤어컷 (60분, 예약형)
- 날짜: 2026-01-16 (목요일)
- 영업 시간: 09:00~18:00
- 슬롯 간격: 60분

**생성 슬롯:**

| 시작 시간 | 종료 시간 | 결과 |
|----------|----------|------|
| 09:00 | 10:00 | ✅ |
| 10:00 | 11:00 | ✅ |
| 11:00 | 12:00 | ✅ |
| 12:00 | 13:00 | ✅ |
| 13:00 | 14:00 | ✅ |
| 14:00 | 15:00 | ✅ |
| 15:00 | 16:00 | ✅ |
| 16:00 | 17:00 | ✅ |
| 17:00 | 18:00 | ✅ |

**총 생성 개수:** 9개

---

#### 시나리오 2: 브레이크타임 적용

**상황:**
- 메뉴: 상담 (30분, 예약형)
- 날짜: 2026-01-16 (목요일)
- 예약 가능 시간대:
    - 오전: 09:00~12:00
    - 오후: 13:00~18:00
- 슬롯 간격: 30분

**생성 슬롯:**

| 시간대 | 생성 슬롯 | 개수 |
|--------|----------|------|
| 오전 (09:00~12:00) | 09:00, 09:30, 10:00, 10:30, 11:00, 11:30 | 6개 |
| 브레이크 (12:00~13:00) | (생성 안 함) | 0개 |
| 오후 (13:00~18:00) | 13:00, 13:30, 14:00, 14:30, 15:00, 15:30, 16:00, 16:30, 17:00, 17:30 | 10개 |

**총 생성 개수:** 16개

---

#### 시나리오 3: 같은 시간대 다른 메뉴 (Phase 2)

**상황:**
- 메뉴 1: 헤어컷 (60분, 예약형)
- 메뉴 2: 파마 (120분, 예약형)
- 날짜: 2026-01-16 (목요일)
- 예약 가능 시간대: 09:00~12:00
- 슬롯 간격: 각 메뉴의 소요 시간과 동일

**생성 슬롯:**

```
09:00 시간대:
├─ 헤어컷: 09:00-10:00 ✅ (menu_id=A)
└─ 파마:   09:00-11:00 ✅ (menu_id=B)

10:00 시간대:
├─ 헤어컷: 10:00-11:00 ✅ (menu_id=A)
└─ 파마:   생성 안 함 (11:00-13:00 → 종료 시간 초과)

11:00 시간대:
└─ 헤어컷: 11:00-12:00 ✅ (menu_id=A)
```

**결과:**
- 헤어컷: 3개 슬롯 (09:00, 10:00, 11:00)
- 파마: 1개 슬롯 (09:00)
- 총 4개 슬롯 공존 (Phase 2 목표 달성)

---

### 6.2 오류 케이스

#### 시나리오 4: 날짜 순서 오류

**상황:**
- 시작 날짜: 2026-01-31
- 종료 날짜: 2026-01-16

**검증:**

```
조건: endDate ≥ startDate
계산: 2026-01-16 ≥ 2026-01-31 → False
```

**결과:** ❌ 생성 실패

**오류 메시지:**
```
"종료 날짜(2026-01-16)는 시작 날짜(2026-01-31)보다 늦어야 합니다."
```

---

#### 시나리오 5: 슬롯 간격 초과

**상황:**
- 메뉴: 헤어컷 (60분)
- 슬롯 간격: 90분

**검증:**

```
조건: slotIntervalMinutes ≤ durationMinutes
계산: 90 ≤ 60 → False
```

**결과:** ❌ 생성 실패

**오류 메시지:**
```
"슬롯 간격(90분)은 소요 시간(60분)보다 클 수 없습니다."
```

---

#### 시나리오 6: 필수 파라미터 누락

**상황:**
- autoGenerateSlots: true
- slotSettings: null

**검증:**

```java
if (request.autoGenerateSlots() && request.slotSettings() == null) {
    throw new ValidationException("슬롯 설정이 필요합니다");
}
```

**결과:** ❌ 생성 실패

**오류 메시지:**
```
"자동 생성을 활성화하려면 슬롯 설정(날짜 범위, 슬롯 간격)을 입력해주세요."
```

---

### 6.3 경계 조건

#### 시나리오 7: 종료 시간 정각 경계

**상황:**
- 메뉴: 파마 (120분)
- 예약 가능 시간대: 09:00~12:00
- 슬롯 간격: 120분

**생성 슬롯:**

| 시작 | 종료 | 검증 | 결과 |
|------|------|------|------|
| 09:00 | 11:00 | 11:00 ≤ 12:00 | ✅ 생성 |
| 10:00 | 12:00 | 12:00 ≤ 12:00 | ✅ 생성 (정각 경계 허용) |
| 11:00 | 13:00 | 13:00 > 12:00 | ❌ Skip |

**총 생성 개수:** 2개

---

#### 시나리오 8: 단일 날짜

**상황:**
- 시작 날짜: 2026-01-16
- 종료 날짜: 2026-01-16

**검증:**

```
조건: endDate ≥ startDate
계산: 2026-01-16 ≥ 2026-01-16 → True
```

**결과:** ✅ 정상 (1일치 슬롯 생성)

---

#### 시나리오 9: 휴무일 제외

**상황:**
- 날짜 범위: 2026-01-16 ~ 2026-01-18 (목~토)
- 토요일(2026-01-18): 휴무일

**생성 슬롯:**

| 날짜 | 요일 | 상태 | 생성 개수 |
|------|------|------|----------|
| 2026-01-16 | 목요일 | 영업 | 9개 |
| 2026-01-17 | 금요일 | 영업 | 9개 |
| 2026-01-18 | 토요일 | **휴무** | 0개 (Skip) |

**총 생성 개수:** 18개

---

## 6. BookingSlot 생명주기 및 관리

### 6.1 슬롯 상태 관리

BookingSlot은 예약 가능 여부에 따라 상태가 변경된다.

**상태 전이:**

```
[AVAILABLE]          (예약 가능)
    ↓ 고객 예약
[RESERVED]           (예약됨)
    ↓ 서비스 제공 완료
[COMPLETED]          (완료)

[RESERVED] → [AVAILABLE]  (예약 취소 시)
```

**상태별 설명:**

| 상태 | 코드 | 설명 | isAvailable | 예약 가능 |
|------|------|------|-------------|----------|
| 예약 가능 | AVAILABLE | 아직 예약되지 않음 | true | ✅ |
| 예약됨 | RESERVED | 고객 예약 완료 | false | ❌ |
| 완료 | COMPLETED | 서비스 제공 완료 | false | ❌ |

---

### 6.2 Reservation과의 관계

**1:1 관계:**

하나의 BookingSlot은 최대 하나의 Reservation만 가질 수 있다.

```
BookingSlot (1) ─── (0..1) Reservation

슬롯 1개 = 예약 0개 (예약 가능) 또는 1개 (예약됨)
```

**예약 생성 시:**

```
[고객이 예약 생성]
    ↓
BookingSlot 조회 (slotId)
    ↓
상태 확인 (isAvailable = true?)
    ↓
Reservation 생성
    ↓
BookingSlot 상태 변경:
  - status: AVAILABLE → RESERVED
  - isAvailable: true → false
```

**예약 취소 시:**

```
[고객/업체가 예약 취소]
    ↓
Reservation 상태 변경 (CANCELLED)
    ↓
BookingSlot 상태 복원:
  - status: RESERVED → AVAILABLE
  - isAvailable: false → true
    ↓
[다시 예약 가능]
```

---

### 6.3 전체 생성 개수 산정

**계산 공식:**

```
총 슬롯 개수 = Σ(각 날짜별 슬롯 개수)

각 날짜별 슬롯 개수 = Σ(각 예약 가능 시간대별 슬롯 개수)

각 시간대별 슬롯 개수 = ⌊(closeTime - openTime) / slotInterval⌋
```

**예시 1: 단일 시간대**

```
조건:
- 기간: 2026-01-16 ~ 2026-01-20 (5일, 월~금)
- 영업 시간: 09:00~18:00 (9시간 = 540분)
- 슬롯 간격: 60분
- 휴무일: 없음

계산:
- 하루 슬롯 개수: ⌊540 / 60⌋ = 9개
- 총 슬롯 개수: 9개 × 5일 = 45개
```

**예시 2: 브레이크타임 (복수 시간대)**

```
조건:
- 기간: 2026-01-16 ~ 2026-01-20 (5일, 월~금)
- 예약 가능 시간대:
  * 오전: 09:00~12:00 (180분)
  * 오후: 13:00~18:00 (300분)
- 슬롯 간격: 60분
- 휴무일: 없음

계산:
- 오전 슬롯: ⌊180 / 60⌋ = 3개
- 오후 슬롯: ⌊300 / 60⌋ = 5개
- 하루 슬롯 개수: 3 + 5 = 8개
- 총 슬롯 개수: 8개 × 5일 = 40개
```

**예시 3: 휴무일 포함**

```
조건:
- 기간: 2026-01-16 ~ 2026-01-19 (4일, 목~일)
- 영업 시간: 09:00~18:00 (540분)
- 슬롯 간격: 60분
- 휴무일: 토요일(1/18), 일요일(1/19)

계산:
- 하루 슬롯 개수: 9개
- 영업일: 목(1/16), 금(1/17) = 2일
- 총 슬롯 개수: 9개 × 2일 = 18개
```

---

### 6.4 슬롯 활용률 추적

**주요 지표:**

| 지표 | 계산 방식 | 설명 |
|------|----------|------|
| 예약률 | (예약된 슬롯 / 전체 슬롯) × 100% | 전체 슬롯 중 예약된 비율 |
| 가동률 | (완료된 슬롯 / 전체 슬롯) × 100% | 실제 서비스 제공된 비율 |
| 노쇼율 | (노쇼 예약 / 예약된 슬롯) × 100% | 예약 후 미방문 비율 |

**예시:**

```
2026-01-16 슬롯 현황:
- 전체 슬롯: 9개
- 예약됨(RESERVED): 5개
- 예약 가능(AVAILABLE): 4개

예약률 = (5 / 9) × 100% = 55.6%
```

---

## 7. 메뉴 수정 시 BookingSlot 처리

### 7.1 소요 시간(durationMinutes) 변경

메뉴의 소요 시간이 변경되면 BookingSlot의 종료 시간도 함께 변경되어야 한다.

**처리 원칙:**

| 구분 | 처리 방식 | 사유 |
|------|----------|------|
| 미래 예약 없는 슬롯 | 삭제 후 재생성 | 새 소요 시간 반영 |
| 미래 예약 있는 슬롯 | 변경 불가 | 고객 약속 보호 |
| 과거 슬롯 | 유지 | 통계/증빙 보존 |

---

**규칙 MS-01: 미래 예약 보호**

소요 시간 변경 시, 미래 예약이 존재하면 변경을 거부한다.

```
검증 조건:
  해당 Menu의 예약 중:
    AND 예약 날짜 ≥ 오늘
    AND 예약 상태 IN (PENDING, CONFIRMED)
```

**예시:**

```
현재 상태:
  메뉴: 헤어컷 (60분)
  미래 예약:
    - 2026-01-20 10:00~11:00 (CONFIRMED)
    - 2026-01-25 14:00~15:00 (PENDING)

변경 시도: 소요 시간 60분 → 90분
```

**검증:**

| 예약 | 예약 날짜 | 기존 시간 | 새 소요 시간 적용 시 | 영향 |
|------|----------|----------|---------------------|------|
| 2026-01-20 | 미래 | 10:00~11:00 | 10:00~11:30 | ⚠️ 30분 연장 |
| 2026-01-25 | 미래 | 14:00~15:00 | 14:00~15:30 | ⚠️ 30분 연장 |

**결과:** ❌ 변경 거부

**오류 메시지:**
```
"해당 메뉴에 2건의 예약이 예정되어 있습니다.
(가장 빠른 예약: 2026-01-20 10:00)

소요 시간을 변경하면 다음 예약이 영향받습니다:
- 2026-01-20 10:00~11:00 → 10:00~11:30 (30분 연장)
- 2026-01-25 14:00~15:00 → 14:00~15:30 (30분 연장)

먼저 고객과 협의 후 예약을 취소하거나 시간을 조정해주세요."
```

---

**규칙 MS-02: 과거 슬롯 보존**

과거 날짜의 BookingSlot은 삭제하지 않고 보존한다.

```
보존 대상: slotDate < 오늘
```

**사유:**

| 항목 | 내용 |
|------|------|
| 통계 분석 | 과거 예약률, 가동률 계산에 필요 |
| 매출 증빙 | 세금 신고, 회계 자료로 활용 |
| 고객 이력 | 방문 기록 추적에 필요 |

**예시:**

```
현재 날짜: 2026-01-15
메뉴: 헤어컷 (60분 → 90분 변경)

BookingSlot 현황:
- 2026-01-10 09:00~10:00 (과거) → 유지 ✅
- 2026-01-20 10:00~11:00 (미래) → 삭제 후 재생성
```

---

**규칙 MS-03: 미래 슬롯 재생성**

미래 예약이 없는 슬롯은 삭제 후 새로운 소요 시간으로 재생성한다.

```
재생성 대상:
  AND slotDate ≥ 오늘
  AND 해당 슬롯에 예약 없음 (status = AVAILABLE)
```

**처리 흐름:**

```
[소요 시간 변경 요청]
    ↓
미래 예약 존재 확인
    ↓
예약 있음?
  YES → ❌ 변경 거부
  NO → 계속 진행
    ↓
미래 슬롯 삭제:
  - slotDate ≥ 오늘
  - status = AVAILABLE
    ↓
새로운 슬롯 재생성:
  - 새 소요 시간 적용
  - 동일 날짜 범위
    ↓
[변경 완료]
```

**예시:**

```
현재 날짜: 2026-01-15
메뉴: 헤어컷 (60분 → 90분 변경)
날짜 범위: 2026-01-16 ~ 2026-01-31

[1단계] 미래 예약 확인
  → 예약 없음 ✅

[2단계] 미래 슬롯 삭제
  삭제 대상: 2026-01-16 ~ 2026-01-31 (AVAILABLE 슬롯만)
  삭제 개수: 120개

[3단계] 슬롯 재생성
  새 소요 시간: 90분
  새 슬롯 간격: 90분
  생성 개수: 80개

변경 결과:
  - 기존: 60분 슬롯 120개
  - 변경: 90분 슬롯 80개
```

---

### 7.2 메뉴 활성화/비활성화

**규칙 MS-04: 비활성화 시 미래 예약 보호**

메뉴를 비활성화하더라도 미래 예약은 유지된다.

```
메뉴 비활성화 시:
  1. Menu.isActive = false
  2. 미래 BookingSlot.isAvailable = false (신규 예약 차단)
  3. 기존 예약(RESERVED) 유지
  
결과:
  - 신규 예약 차단 ✅
  - 기존 예약 유지 ✅
```

**예시:**

```
현재 상태:
  메뉴: 헤어컷 (활성)
  미래 슬롯:
    - 2026-01-20 10:00 (RESERVED) ← 예약됨
    - 2026-01-20 11:00 (AVAILABLE) ← 예약 가능
    - 2026-01-20 14:00 (AVAILABLE) ← 예약 가능

메뉴 비활성화 실행
```

**결과:**

| 슬롯 | 변경 전 | 변경 후 | 고객 영향 |
|------|---------|---------|----------|
| 10:00 (RESERVED) | 예약됨 | 예약됨 유지 | 없음 (서비스 제공) |
| 11:00 (AVAILABLE) | 예약 가능 | **예약 불가** | 신규 예약 차단 |
| 14:00 (AVAILABLE) | 예약 가능 | **예약 불가** | 신규 예약 차단 |

---

### 7.3 메뉴 삭제 (논리 삭제)

**규칙 MS-05: 미래 예약 존재 시 삭제 불가**

메뉴 삭제 시도 시, 미래 예약이 있으면 거부한다.

```
삭제 가능 조건:
  해당 Menu의 예약 중:
    미래 예약 (날짜 ≥ 오늘, 상태 = PENDING/CONFIRMED) 없음
```

**예시:**

```
메뉴: 헤어컷
미래 예약: 1건 (2026-01-20 10:00)

삭제 시도 → ❌ 거부
```

**오류 메시지:**
```
"해당 메뉴에 1건의 예약이 예정되어 있습니다.
(가장 빠른 예약: 2026-01-20 10:00)

먼저 고객과 협의 후 예약을 취소해주세요."
```

---

## 8. 검증 시나리오

### 8.1 정상 케이스

#### 시나리오 1: 기본 슬롯 생성 (15일 기간)

**상황:**
- 메뉴: 헤어컷 (60분, 예약형)
- 기간: 2026-01-16 ~ 2026-01-31 (16일)
- 영업 시간: 09:00~18:00 (월~금)
- 휴무일: 토~일
- 슬롯 간격: 60분

**날짜별 분석:**

| 날짜 | 요일 | 상태 | 슬롯 개수 |
|------|------|------|----------|
| 1/16 | 목 | 영업 | 9개 |
| 1/17 | 금 | 영업 | 9개 |
| 1/18 | 토 | 휴무 | 0개 |
| 1/19 | 일 | 휴무 | 0개 |
| 1/20~1/24 | 월~금 | 영업 | 45개 (9×5) |
| 1/25 | 토 | 휴무 | 0개 |
| 1/26 | 일 | 휴무 | 0개 |
| 1/27~1/31 | 월~금 | 영업 | 45개 (9×5) |

**총 생성 개수:** 108개
- 영업일: 12일 (월~금)
- 하루 슬롯: 9개
- 계산: 9 × 12 = 108개

---

#### 시나리오 2: 브레이크타임 적용 (15일 기간)

**상황:**
- 메뉴: 상담 (30분, 예약형)
- 기간: 2026-01-16 ~ 2026-01-31 (16일)
- 예약 가능 시간대:
    - 오전: 09:00~12:00 (6개 슬롯)
    - 오후: 13:00~18:00 (10개 슬롯)
- 휴무일: 토~일
- 슬롯 간격: 30분

**계산:**
- 하루 슬롯: 6 + 10 = 16개
- 영업일: 12일
- 총 생성 개수: 16 × 12 = 192개

---

#### 시나리오 3: 같은 시간대 다른 메뉴

**상황:**
- 메뉴 1: 헤어컷 (60분, 슬롯 간격 60분)
- 메뉴 2: 파마 (120분, 슬롯 간격 120분)
- 날짜: 2026-01-16 (목요일, 1일만)
- 예약 가능 시간대: 09:00~12:00

**생성 슬롯:**

```
09:00 시간대:
├─ 헤어컷: 09:00-10:00 ✅ (menu_id=A)
└─ 파마:   09:00-11:00 ✅ (menu_id=B)

10:00 시간대:
├─ 헤어컷: 10:00-11:00 ✅ (menu_id=A)
└─ 파마:   생성 안 함 (종료 시간 초과)

11:00 시간대:
└─ 헤어컷: 11:00-12:00 ✅ (menu_id=A)
```

**총 생성 개수:** 4개
- 헤어컷: 3개
- 파마: 1개

**Reservation 충돌 체크:**

```
슬롯 레벨: menu_id로 구분하여 다른 메뉴 슬롯 공존
  ↓
예약 레벨: business_id로 시간 충돌 검증

고객 A: 파마 09:00-11:00 예약 생성 ✅
  → BookingSlot(파마 09:00) 상태: AVAILABLE → RESERVED
  
고객 B: 헤어컷 09:00-10:00 예약 시도 ❌
  → BookingSlot(헤어컷 09:00) 상태: AVAILABLE (예약 가능)
  → Reservation 검증: 파마(09:00-11:00)와 시간 겹침 감지
  → 예약 거부: "해당 시간대에 이미 예약이 있습니다"

결과:
  - BookingSlot은 메뉴별로 독립적으로 존재
  - Reservation은 업체 전체 시간대를 기준으로 충돌 검증
```

---

### 8.2 메뉴 수정 케이스

#### 시나리오 4: 소요 시간 변경 (미래 예약 없음)

**상황:**
- 메뉴: 헤어컷 (60분 → 90분)
- 현재 날짜: 2026-01-15
- 슬롯 기간: 2026-01-16 ~ 2026-01-31
- 미래 예약: 없음

**처리:**

| 단계 | 작업 | 결과 |
|------|------|------|
| 1 | 미래 예약 확인 | 없음 ✅ |
| 2 | 미래 슬롯 삭제 (2026-01-16~) | 108개 삭제 |
| 3 | 새 슬롯 재생성 (90분) | 72개 생성 |

**변경 결과:**
- 기존: 60분 슬롯 108개 (하루 9개 × 12일)
- 변경: 90분 슬롯 72개 (하루 6개 × 12일)
- 슬롯 수 감소: -36개 (소요 시간 증가로 인한 자연스러운 감소)

---

#### 시나리오 5: 소요 시간 변경 (미래 예약 존재)

**상황:**
- 메뉴: 헤어컷 (60분 → 90분)
- 현재 날짜: 2026-01-15
- 미래 예약: 2건
    - 2026-01-20 10:00~11:00 (CONFIRMED)
    - 2026-01-25 14:00~15:00 (PENDING)

**검증:**

| 예약 | 현재 | 변경 시 | 영향 |
|------|------|---------|------|
| 2026-01-20 | 10:00~11:00 | 10:00~11:30 | ⚠️ +30분 |
| 2026-01-25 | 14:00~15:00 | 14:00~15:30 | ⚠️ +30분 |

**결과:** ❌ 변경 거부

---

#### 시나리오 6: 메뉴 비활성화

**상황:**
- 메뉴: 헤어컷 (활성 → 비활성)
- 미래 슬롯:
    - 2026-01-20 10:00 (RESERVED)
    - 2026-01-20 11:00 (AVAILABLE)
    - 2026-01-20 14:00 (AVAILABLE)

**처리:**

| 슬롯 | 변경 전 | 변경 후 | 설명 |
|------|---------|---------|------|
| 10:00 | RESERVED | RESERVED | 기존 예약 유지 |
| 11:00 | AVAILABLE | AVAILABLE (비활성) | 신규 예약 불가 |
| 14:00 | AVAILABLE | AVAILABLE (비활성) | 신규 예약 불가 |

**고객 관점:**
- 기존 예약 고객: 정상 서비스 제공
- 신규 예약 시도: "해당 메뉴는 현재 예약할 수 없습니다"

---

### 8.3 오류 케이스

#### 시나리오 7: 날짜 순서 오류

**상황:**
- 시작 날짜: 2026-01-31
- 종료 날짜: 2026-01-16

**결과:** ❌ 생성 실패

**오류 메시지:**
```
"종료 날짜(2026-01-16)는 시작 날짜(2026-01-31)보다 늦어야 합니다."
```

---

#### 시나리오 8: 슬롯 간격 초과

**상황:**
- 메뉴: 헤어컷 (60분)
- 슬롯 간격: 90분

**결과:** ❌ 생성 실패

**오류 메시지:**
```
"슬롯 간격(90분)은 소요 시간(60분)보다 클 수 없습니다."
```

---

### 8.4 경계 조건

#### 시나리오 9: 종료 시간 정각 경계

**상황:**
- 메뉴: 파마 (120분)
- 예약 가능 시간대: 09:00~12:00
- 슬롯 간격: 120분

**생성 슬롯:**

| 시작 | 종료 | 검증 | 결과 |
|------|------|------|------|
| 09:00 | 11:00 | 11:00 ≤ 12:00 | ✅ |
| 10:00 | 12:00 | 12:00 ≤ 12:00 | ✅ (정각 허용) |
| 11:00 | 13:00 | 13:00 > 12:00 | ❌ Skip |

**총 생성:** 2개

---

#### 시나리오 10: 단일 날짜

**상황:**
- 시작 날짜: 2026-01-16
- 종료 날짜: 2026-01-16

**결과:** ✅ 정상 (1일치 슬롯 생성)

---